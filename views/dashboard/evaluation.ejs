<%
  // Use server-provided evaluation practice history. Server should pass `evaluationPracticeHistory` and optionally `activeEvalPeriodId`.
  const evalPractice = (typeof evaluationPracticeHistory !== 'undefined' && Array.isArray(evaluationPracticeHistory))
    ? evaluationPracticeHistory
    : [];

  const activeEvalPeriod = (typeof activeEvalPeriodId !== 'undefined')
    ? evalPractice.find(p => p.id === activeEvalPeriodId)
    : evalPractice.find(p => p.status === 'active');

  const currentEvalData = activeEvalPeriod || (evalPractice.length > 0 ? evalPractice[evalPractice.length - 1] : null);
  const userYear = user.year || 3;

  const hasPractice = evalPractice.length > 0;
  const hasActive = !!activeEvalPeriod;

  // Check if user is pure admin (admin role without student ID)
  const isPureAdmin = user && user.role === 'admin' && !user.studentId;
%>

<div class="page-content">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;gap:16px;flex-wrap:wrap">
      <div>
        <h2 style="margin:0 0 8px 0;color:var(--color-primary);display:flex;align-items:center;gap:12px">
          <span>üìù</span>
          ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô
        </h2>
        <p class="text-muted" style="margin:0">‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ù‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û‡∏Ñ‡∏£‡∏π</p>
      </div>
      
      <div class="form-group" style="margin:0;min-width:300px">
        <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏ß‡∏î‡∏ù‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå</label>
        <select id="evalPeriodSelector" class="form-input" onchange="changeEvalPeriod()" style="padding:10px 14px">
          <% if (!hasPractice) { %>
            <option value="none" selected disabled>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ß‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå</option>
          <% } else { %>
            <% evalPractice.slice().reverse().forEach((record) => { %>
              <option value="<%= record.id %>" <%= record.status === 'active' ? 'selected' : '' %>>
                <%= record.period %> (‡∏õ‡∏µ <%= record.year %>)
                <%= record.status === 'active' ? ' - ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô' : '' %>
              </option>
            <% }); %>
          <% } %>
        </select>
      </div>
    </div>

    <% if (isPureAdmin) { %>
      <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <span style="font-size: 1.5rem;">üîí</span>
          <h3 style="margin: 0; font-size: 1.2rem;">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</h3>
        </div>
        <p style="margin: 0; font-size: 1rem; line-height: 1.5; opacity: 0.95;">‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞ <strong>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</strong> ‡∏ã‡∏∂‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ<br>‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
      </div>
    <% } else if (!hasActive) { %>
      <div id="noEvalActiveBanner" style="background:#fff3cd;border-left:4px solid #ffc107;padding:12px;border-radius:8px;margin-bottom:16px;color:#856404">
        ‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ß‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" ‚Äî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ß‡∏î‡∏ù‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà
      </div>
    <% } %>

    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ (Read-only) -->
    <div id="evalHistoryView" style="display:none">
      <div style="background:rgba(251,180,37,0.1);border-left:4px solid var(--color-secondary);padding:16px;border-radius:8px;margin-bottom:24px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <span style="font-size:1.3rem">üìö</span>
          <strong style="color:var(--color-text);font-size:1.1rem">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (Read-Only)</strong>
        </div>
        <p style="margin:0;color:var(--color-muted);font-size:0.9rem">
          ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏á‡∏ß‡∏î‡∏ù‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
        </p>
      </div>
      <div id="evalHistoryContent"></div>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏ß‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Editable) -->
    <% if (!isPureAdmin) { %>
    <div id="evalCurrentContent">
        <!-- Practice Period Info -->
        <div class="info-banner" style="background:var(--color-bg);border-left:4px solid var(--color-primary);padding:16px;border-radius:8px;margin-bottom:24px">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
          <span style="font-size:1.5rem">üìÖ</span>
          <div>
            <strong style="color:var(--color-text)">‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå:</strong>
            <span id="practiceRange">-</span>
          </div>
        </div>
        <div style="margin:8px 0 0 44px;font-size:0.9rem;color:var(--color-muted)">
          <strong style="color:var(--color-text)">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà <%= userYear %>:</strong>
          <% if (userYear <= 3) { %>
            <span>‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô <strong>9 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</strong> (3 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå √ó 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</span>
          <% } else { %>
            <span style="color:var(--color-success)">‚úÖ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏õ‡∏µ 4 ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô)</span>
          <% } %>
        </div>
        <% if (userYear <= 3) { %>
          <p style="margin:8px 0 0 44px;font-size:0.9rem;color:var(--color-muted)">
            * ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ù‡∏∂‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ô‡∏¥‡πÄ‡∏ó‡∏®
          </p>
        <% } %>
      </div>

      <!-- Lesson Plan Upload Section (Separate Task) -->
      <% if (userYear <= 3) { %>
      <div class="card" style="margin-bottom:24px;background:var(--color-bg);border:2px dashed var(--color-primary)">
        <h3 style="color:var(--color-primary);margin:0 0 16px 0;display:flex;align-items:center;gap:12px">
          <span>üìã</span>
          ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ
          <span style="background:var(--color-warning);color:white;font-size:0.75rem;padding:4px 12px;border-radius:12px;font-weight:600">‡∏á‡∏≤‡∏ô‡πÅ‡∏¢‡∏Å</span>
        </h3>
        <p style="margin:0 0 16px 0;color:var(--color-muted)">
          ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà 1-3 ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå
        </p>

      <!-- Lesson Plan Upload UI -->
      <div style="background:white;padding:20px;border-radius:8px;border:1px solid var(--color-border)">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px">
          <input type="file" id="mainLessonPlanInput" accept=".pdf,.doc,.docx,.ppt,.pptx" style="display:none">
          <button type="button" class="btn btn--primary" onclick="document.getElementById('mainLessonPlanInput').click()" style="display:flex;align-items:center;gap:8px">
            <span>üìé</span>
            ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ
          </button>
          <span id="mainLessonPlanFileName" style="color:var(--color-muted);font-size:0.9rem">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</span>
        </div>

        <div id="mainLessonPlanPreview" style="display:none;background:var(--color-bg);padding:16px;border-radius:8px;border:1px solid var(--color-border)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <strong style="color:var(--color-text)">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå:</strong>
            <button type="button" class="btn btn--danger btn--icon" onclick="removeMainLessonPlan()" title="‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå">
              üóëÔ∏è
            </button>
          </div>
          <div id="mainLessonPlanPreviewContent"></div>
        </div>

        <div style="margin-top:16px;text-align:right">
          <button type="button" class="btn btn--success" onclick="submitLessonPlan()" id="submitLessonPlanBtn" disabled style="display:flex;align-items:center;gap:8px;margin-left:auto">
            <span>üì§</span>
            ‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ
          </button>
        </div>
      </div>
      
        <!-- Lesson Plan Status -->
        <div id="lessonPlanStatus" style="margin-top:16px;padding:12px;border-radius:8px;background:#fff3cd;color:#856404;display:none">
          <div style="display:flex;align-items:center;gap:8px">
            <span>üìã</span>
            <span id="lessonPlanStatusText">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</span>
          </div>
        </div>
      </div>
      <% } %>

      <!-- Evaluation Grid: 3 weeks √ó 3 evaluations -->
      <% if (userYear <= 3) { %>
      <div style="margin-top:24px">
        <% for (let week = 1; week <= 3; week++) { %>
          <div class="eval-week-section" style="margin-bottom:32px">
            <h3 style="color:var(--color-primary);margin:0 0 16px 0;display:flex;align-items:center;gap:8px">
              <span>üìå</span>
              ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà <%= week %>
            </h3>
            
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px">
              <% for (let evalNum = 1; evalNum <= 3; evalNum++) { 
                 const globalNum = (week - 1) * 3 + evalNum;
              %>
                <div class="eval-card" data-eval="<%= globalNum %>">
                  <div class="eval-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h4 style="margin:0;color:var(--color-text)">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà <%= globalNum %></h4>
                    <span class="eval-status pending" id="status-<%= globalNum %>">
                      <span class="status-icon">‚è≥</span>
                      <span class="status-text">‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</span>
                    </span>
                  </div>
                  
                  <div class="eval-date" id="date-<%= globalNum %>" style="font-size:0.85rem;color:var(--color-muted);margin-bottom:12px">
                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="date-value">-</span>
                  </div>

                  <button class="btn btn--primary btn-eval" 
                          data-eval="<%= globalNum %>" 
                          onclick="startEvaluation(<%= globalNum %>)"
                          style="width:100%">
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
                  </button>
                </div>
              <% } %>
            </div>
          </div>
        <% } %>
      </div>
      <% } else { %>
        <div style="text-align:center;padding:60px 20px;background:var(--color-bg);border-radius:12px;border:2px dashed var(--color-border)">
          <div style="font-size:4rem;margin-bottom:16px">üéì</div>
          <h3 style="color:var(--color-primary);margin:0 0 12px 0">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà 4 ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h3>
          <p style="color:var(--color-muted);margin:0">‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ù‡∏∂‡∏Å‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏ß‡∏•‡∏≤ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ</p>
        </div>
      <% } %>
    </div>
    <% } %>
  </div>
</div>

<!-- Evaluation Details Modal (Read-only) -->
<div id="evaluationDetailsModal" class="modal-overlay" style="display:none">
  <div class="modal-content" style="max-width:1000px;max-height:90vh">
    <div class="modal-header">
      <h3>üìä ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô - <span id="detailsEvalTitle">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1</span></h3>
      <button type="button" class="modal-close" onclick="closeDetailsModal()">√ó</button>
    </div>
    
    <div class="modal-body" style="padding:24px">
      <div class="eval-info" style="background:var(--color-bg);padding:12px;border-radius:6px;margin-bottom:20px">
        <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</strong> <span id="detailsEvalDate">-</span>
      </div>

      <div id="detailsContent"></div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn--secondary" onclick="closeDetailsModal()">
        ‡∏õ‡∏¥‡∏î
      </button>
    </div>
  </div>
</div>

<!-- Evaluation Modal -->
<div id="evaluationModal" class="modal-overlay" style="display:none">
  <div class="modal-content" style="max-width:900px;max-height:90vh">
    <div class="modal-header">
      <h3>‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô - <span id="evalTitle">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà 1</span></h3>
      <button type="button" class="modal-close" onclick="closeEvaluationModal()">√ó</button>
    </div>
    
    <div class="modal-body" style="padding:24px">
      <div class="eval-info" style="background:var(--color-bg);padding:12px;border-radius:6px;margin-bottom:20px">
        <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô:</strong> <span id="modalEvalDate">-</span>
      </div>

      <form id="evaluationForm">
        <!-- Teacher Verbal Behaviors -->
        <div class="eval-section">
          <h4 class="section-title">‡∏Ñ‡∏£‡∏π - ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤ (Verbal Behaviors)</h4>
          <div class="question-list">
            <div class="question-item">
              <label class="question-label">1. ‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Å‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q1" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">2. ‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏Å‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q2" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">3. ‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏Å‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q3" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">4. ‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ï‡∏±‡∏Å‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q4" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- Teacher Non-Verbal Behaviors -->
        <div class="eval-section">
          <h4 class="section-title">‡∏Ñ‡∏£‡∏π - ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏†‡∏≤‡∏©‡∏≤ (Non-Verbal Behavior)</h4>
          <div class="question-list">
            <div class="question-item">
              <label class="question-label">5. ‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏á‡∏µ‡∏¢‡∏ö</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q5" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">6. ‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡πâ‡∏° ‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡∏∞</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q6" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">7. ‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q7" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">8. ‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q8" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">9. ‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô/ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏≠‡∏£‡πå‡∏î/ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q9" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- Student Academic Behaviors -->
        <div class="eval-section">
          <h4 class="section-title">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
          <div class="question-list">
            <div class="question-item">
              <label class="question-label">1. ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡πà‡∏á‡∏°‡∏≠‡∏á‡πÉ‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q10" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">2. ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q11" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">3. ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q12" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">4. ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡πà‡∏á‡∏°‡∏≠‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q13" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">5. ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q14" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">6. ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q15" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- Student Work Behaviors -->
        <div class="eval-section">
          <h4 class="section-title">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
          <div class="question-list">
            <div class="question-item">
              <label class="question-label">1. ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q16" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">2. ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q17" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">3. ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q18" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- Learning Environment -->
        <div class="eval-section">
          <h4 class="section-title">‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ - ‡∏™‡∏†‡∏≤‡∏û‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h4>
          <div class="question-list">
            <div class="question-item">
              <label class="question-label">1. ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏Å‡∏õ‡∏£‡∏Å</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q19" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">2. ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ï‡πà‡∏≠‡∏û‡πà‡∏ß‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏õ‡πâ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå ‡πÄ‡∏°‡∏≤‡∏™‡πå ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q20" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">3. ‡∏ù‡∏≤‡∏ú‡∏ô‡∏±‡∏á‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q21" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">4. ‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ 1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 1 ‡∏Ñ‡∏ô</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q22" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">5. ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q23" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">6. ‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏µ‡∏ß‡∏µ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏≠‡∏â‡∏≤‡∏¢ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q24" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">7. ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏°‡∏µ‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å‡∏à‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q25" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>

            <div class="question-item">
              <label class="question-label">8. ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏°‡∏µ‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</label>
              <div class="rating-group">
                <% for (let i = 1; i <= 5; i++) { %>
                  <label class="rating-option">
                    <input type="radio" name="q26" value="<%= i %>" required>
                    <span><%= i %></span>
                  </label>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <div class="rating-legend" style="background:var(--color-bg);padding:12px;border-radius:6px;margin-top:24px;text-align:center">
          <strong>‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</strong>
          <span style="margin-left:16px">1 = ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</span>
          <span style="margin-left:8px">|</span>
          <span style="margin-left:8px">2 = ‡∏û‡∏≠‡πÉ‡∏ä‡πâ</span>
          <span style="margin-left:8px">|</span>
          <span style="margin-left:8px">3 = ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</span>
          <span style="margin-left:8px">|</span>
          <span style="margin-left:8px">4 = ‡∏î‡∏µ</span>
          <span style="margin-left:8px">|</span>
          <span style="margin-left:8px">5 = ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</span>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn--secondary" onclick="closeEvaluationModal()">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
      <button type="button" class="btn btn--primary" onclick="submitEvaluation()">
        ‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
      </button>
    </div>
  </div>
</div>

<style>
.info-banner {
  animation: fadeIn 0.3s ease;
}

.eval-week-section {
  animation: fadeIn 0.4s ease;
}

.eval-card {
  background: var(--color-surface);
  border: 2px solid var(--color-border);
  border-radius: 12px;
  padding: 20px;
  transition: all 0.3s ease;
}

.eval-card:hover {
  border-color: var(--color-primary);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.eval-status {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 500;
}

.eval-status.pending {
  background: #fff3cd;
  color: #856404;
}

.eval-status.completed {
  background: #d4edda;
  color: #155724;
}

.eval-status.locked {
  background: #f8d7da;
  color: #721c24;
}

.btn-eval:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Evaluation Form Styles */
.eval-section {
  margin-bottom: 32px;
  padding: 20px;
  background: var(--color-bg);
  border-radius: 8px;
}

.section-title {
  color: var(--color-primary);
  font-size: 1.1rem;
  font-weight: 600;
  margin: 0 0 16px 0;
  padding-bottom: 8px;
  border-bottom: 2px solid var(--color-border);
}

.question-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.question-item {
  background: var(--color-surface);
  padding: 16px;
  border-radius: 8px;
  border: 1px solid var(--color-border);
}

.question-label {
  display: block;
  font-weight: 500;
  color: var(--color-text);
  margin-bottom: 12px;
}

.rating-group {
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
}

.rating-option {
  position: relative;
  cursor: pointer;
}

.rating-option input[type="radio"] {
  position: absolute;
  opacity: 0;
}

.rating-option span {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 44px;
  height: 44px;
  border: 2px solid var(--color-border);
  border-radius: 50%;
  background: var(--color-surface);
  font-weight: 600;
  color: var(--color-text);
  transition: all 0.2s ease;
}

.rating-option input[type="radio"]:checked + span {
  background: var(--color-primary);
  color: white;
  border-color: var(--color-primary);
  transform: scale(1.1);
}

.rating-option:hover span {
  border-color: var(--color-primary);
  background: var(--color-bg);
}

.rating-legend {
  font-size: 0.9rem;
  color: var(--color-text);
}

/* Modal Styles */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  animation: fadeIn 0.2s ease;
}

/* Ensure SweetAlert2 appears above our modal overlay */
.swal2-container {
  z-index: 999999 !important;
}

.modal-content {
  background: var(--color-surface);
  border-radius: 12px;
  width: 95%;
  overflow-y: auto;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.3s ease;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 2px solid var(--color-border);
  background: var(--color-bg);
}

.modal-header h3 {
  margin: 0;
  color: var(--color-primary);
  font-size: 1.3rem;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.8rem;
  cursor: pointer;
  color: var(--color-muted);
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s ease;
  line-height: 1;
}

.modal-close:hover {
  color: var(--color-danger);
  background: rgba(0, 0, 0, 0.05);
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 20px 24px;
  border-top: 2px solid var(--color-border);
  background: var(--color-bg);
}

.btn--secondary {
  background: var(--color-muted);
  color: white;
}

.btn--secondary:hover {
  background: var(--color-text);
}

/* Read-only Section Styles */
.readonly-section {
  animation: fadeIn 0.4s ease;
}

.readonly-title {
  font-size: 1.15rem;
  font-weight: 600;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--color-border);
}

.readonly-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
}

.readonly-item {
  display: flex;
  flex-direction: column;
  gap: 6px;
  padding: 12px;
  background: var(--color-bg);
  border-radius: 8px;
  border: 1px solid var(--color-border);
}

.readonly-label {
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--color-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.readonly-value {
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-text);
}

/* Evaluation Status Badge Colors */
.eval-status.completed {
  background: #d4edda;
  color: #155724;
}

.eval-status.pending {
  background: #fff3cd;
  color: #856404;
}

.eval-status.locked {
  background: #f8d7da;
  color: #721c24;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Practice history data from server
const evaluationPracticeHistory = <%- JSON.stringify(evalPractice) %>;

const hasPractice = <%= evalPractice.length > 0 ? 'true' : 'false' %>;
const hasActive = <%= activeEvalPeriod ? 'true' : 'false' %>;
const isPureAdminClient = <%= isPureAdmin ? 'true' : 'false' %>;

let currentEvalPeriod = evaluationPracticeHistory.find(p => p.status === 'active') || (evaluationPracticeHistory.length > 0 ? evaluationPracticeHistory[evaluationPracticeHistory.length - 1] : null);
let currentEvalNum = null;
let mainLessonPlanFile = null;
const userYear = <%= userYear %>;

// Change evaluation period
function changeEvalPeriod() {
  const selector = document.getElementById('evalPeriodSelector');
  const selectedId = parseInt(selector.value);
  currentEvalPeriod = evaluationPracticeHistory.find(p => p.id === selectedId);
  
  // Guard: if no period found, do nothing
  if (!currentEvalPeriod) {
    console.warn('No evaluation period found with id:', selectedId);
    return;
  }
  
  if (currentEvalPeriod.status === 'active') {
    // Show editable current content
    document.getElementById('evalHistoryView').style.display = 'none';
    document.getElementById('evalCurrentContent').style.display = 'block';
    loadCurrentPeriodData();
  } else {
    // Show read-only history
    document.getElementById('evalCurrentContent').style.display = 'none';
    document.getElementById('evalHistoryView').style.display = 'block';
    displayEvalHistory();
  }
}

// Display evaluation history (Read-only)
function displayEvalHistory() {
  const container = document.getElementById('evalHistoryContent');
  
  let html = `
    <div class="readonly-section" style="margin-bottom:24px;padding:20px;background:var(--color-surface);border-radius:12px;border:1px solid var(--color-border)">
      <h3 class="readonly-title" style="color:var(--color-primary);margin:0 0 20px 0;display:flex;align-items:center;gap:10px">
        <span>üìÖ</span>
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏ß‡∏î‡∏ù‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå
      </h3>
      <div class="readonly-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px">
        <div class="readonly-item">
          <span class="readonly-label">‡∏á‡∏ß‡∏î‡∏ù‡∏∂‡∏Å:</span>
          <span class="readonly-value">${currentEvalPeriod.period}</span>
        </div>
        <div class="readonly-item">
          <span class="readonly-label">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ:</span>
          <span class="readonly-value">‡∏õ‡∏µ ${currentEvalPeriod.year}</span>
        </div>
        <div class="readonly-item">
          <span class="readonly-label">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</span>
          <span class="readonly-value">${formatThaiDate(currentEvalPeriod.startDate)}</span>
        </div>
        <div class="readonly-item">
          <span class="readonly-label">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</span>
          <span class="readonly-value">${formatThaiDate(currentEvalPeriod.endDate)}</span>
        </div>
      </div>
    </div>
  `;

  // Lesson Plan Status
  if (currentEvalPeriod.lessonPlan && currentEvalPeriod.lessonPlan.uploaded) {
    html += `
      <div class="readonly-section" style="margin-bottom:24px;padding:20px;background:var(--color-surface);border-radius:12px;border:1px solid var(--color-border)">
        <h3 class="readonly-title" style="color:var(--color-success);margin:0 0 16px 0;display:flex;align-items:center;gap:10px">
          <span>üìã</span>
          ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ
        </h3>
        <div style="background:var(--color-bg);padding:16px;border-radius:8px;border:1px solid var(--color-border)">
          <div style="display:flex;align-items:center;gap:16px">
            <div style="font-size:3rem">üìÑ</div>
            <div style="flex:1">
              <div style="font-weight:600;color:var(--color-text);margin-bottom:4px">${currentEvalPeriod.lessonPlan.fileName}</div>
              <div style="font-size:0.85rem;color:var(--color-muted)">
                ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á: ${formatThaiDate(currentEvalPeriod.lessonPlan.submittedDate)}
              </div>
              <div style="margin-top:8px">
                <span style="background:#d4edda;color:#155724;padding:4px 12px;border-radius:12px;font-size:0.8rem;font-weight:500">
                  ‚úì ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  } else {
    html += `
      <div class="readonly-section" style="margin-bottom:24px;padding:20px;background:var(--color-surface);border-radius:12px;border:1px solid var(--color-border)">
        <h3 class="readonly-title" style="color:var(--color-warning);margin:0 0 16px 0;display:flex;align-items:center;gap:10px">
          <span>‚ö†Ô∏è</span>
          ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ
        </h3>
        <div style="background:#fff3cd;padding:16px;border-radius:8px;text-align:center">
          <p style="margin:0;color:#856404">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÉ‡∏ô‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ</p>
        </div>
      </div>
    `;
  }

  // Evaluation Summary
  const totalEvals = currentEvalPeriod.evaluationCount || 9;
  const completedEvals = Object.values(currentEvalPeriod.evaluations || {}).filter(e => e.submitted).length;
  const progressPercent = (completedEvals / totalEvals * 100).toFixed(1);

  html += `
    <div class="readonly-section" style="margin-bottom:24px;padding:20px;background:var(--color-surface);border-radius:12px;border:1px solid var(--color-border)">
      <h3 class="readonly-title" style="color:var(--color-primary);margin:0 0 20px 0;display:flex;align-items:center;gap:10px">
        <span>üìä</span>
        ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
      </h3>
      <div style="background:var(--color-bg);padding:20px;border-radius:8px;margin-bottom:20px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <span style="font-weight:500;color:var(--color-text)">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span>
          <span style="font-weight:600;color:var(--color-primary)">${completedEvals}/${totalEvals} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
        </div>
        <div style="background:#e9ecef;height:24px;border-radius:12px;overflow:hidden">
          <div style="background:var(--color-primary);height:100%;width:${progressPercent}%;transition:width 0.3s ease;display:flex;align-items:center;justify-content:center;color:white;font-size:0.75rem;font-weight:600">
            ${progressPercent}%
          </div>
        </div>
      </div>
  `;

  // Evaluation Grid (Read-only)
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px">';
  
  for (let week = 1; week <= 3; week++) {
    html += `
      <div style="grid-column:1/-1;margin-top:${week > 1 ? '24px' : '0'}">
        <h4 style="color:var(--color-primary);margin:0 0 16px 0;display:flex;align-items:center;gap:8px">
          <span>üìå</span>
          ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${week}
        </h4>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px">
    `;
    
    for (let evalNum = 1; evalNum <= 3; evalNum++) {
      const globalNum = (week - 1) * 3 + evalNum;
      const evalData = currentEvalPeriod.evaluations[globalNum];
      
      const statusClass = evalData && evalData.submitted ? 'completed' : 'pending';
      const statusIcon = evalData && evalData.submitted ? '‚úÖ' : '‚è≥';
      const statusText = evalData && evalData.submitted ? '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥';
      const dateText = evalData && evalData.date ? formatThaiDate(evalData.date) : '-';
      const hasAnswers = evalData && evalData.answers && Object.keys(evalData.answers).length > 0;
      
      html += `
        <div style="background:var(--color-bg);border:2px solid var(--color-border);border-radius:12px;padding:20px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h4 style="margin:0;color:var(--color-text)">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${globalNum}</h4>
            <span class="eval-status ${statusClass}" style="display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:12px;font-size:0.85rem;font-weight:500">
              <span>${statusIcon}</span>
              <span>${statusText}</span>
            </span>
          </div>
          <div style="font-size:0.85rem;color:var(--color-muted);margin-bottom:12px">
            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateText}
          </div>
          ${hasAnswers ? `
            <button class="btn btn--secondary" style="width:100%;font-size:0.9rem;padding:8px 12px" onclick="viewEvaluationDetails(${globalNum})">
              üìä ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
            </button>
          ` : ''}
        </div>
      `;
    }
    
    html += '</div></div>';
  }
  
  html += '</div></div>';
  container.innerHTML = html;
}

// Load current period data
function loadCurrentPeriodData() {
  // Update practice date range
  document.getElementById('practiceRange').textContent = 
    `${formatThaiDate(currentEvalPeriod.startDate)} - ${formatThaiDate(currentEvalPeriod.endDate)}`;

  // Load evaluation states
  loadEvaluationStates();
  
  // Load lesson plan status
  loadLessonPlanStatus();

  // Check if within practice period
  if (!isWithinPracticePeriod()) {
    Swal.fire({
      icon: 'warning',
      title: '‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå',
      html: '‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ù‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå<br>‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:<br><strong>‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ô‡∏¥‡πÄ‡∏ó‡∏® / ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</strong>',
      confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö'
    });
  }
}

// Get question text by question name
function getQuestionText(qName) {
  const questions = {
    q1: '‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Å‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ',
    q2: '‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÅ‡∏Å‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ',
    q3: '‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏Å‡πà‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ',
    q4: '‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡πà‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ï‡∏±‡∏Å‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡∏ï‡∏•‡∏≠‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ',
    q5: '‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏á‡∏µ‡∏¢‡∏ö',
    q6: '‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏¢‡∏¥‡πâ‡∏° ‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡πÄ‡∏£‡∏≤‡∏∞',
    q7: '‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á',
    q8: '‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô',
    q9: '‡∏Ñ‡∏£‡∏π‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô/ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏≠‡∏£‡πå‡∏î/ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠',
    q10: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡πà‡∏á‡∏°‡∏≠‡∏á‡πÉ‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô',
    q11: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
    q12: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
    q13: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡πà‡∏á‡∏°‡∏≠‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô',
    q14: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏π‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
    q15: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Ñ‡∏£‡∏π‡∏™‡∏≠‡∏ô',
    q16: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',
    q17: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô',
    q18: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô',
    q19: '‡∏û‡∏∑‡πâ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏Å‡∏õ‡∏£‡∏Å',
    q20: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ï‡πà‡∏≠‡∏û‡πà‡∏ß‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏õ‡πâ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå ‡πÄ‡∏°‡∏≤‡∏™‡πå ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ',
    q21: '‡∏ù‡∏≤‡∏ú‡∏ô‡∏±‡∏á‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô',
    q22: '‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ 1 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 1 ‡∏Ñ‡∏ô',
    q23: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á',
    q24: '‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏µ‡∏ß‡∏µ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏≠‡∏â‡∏≤‡∏¢ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô',
    q25: '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏°‡∏µ‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡∏°‡∏≤‡∏Å‡∏à‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ',
    q26: '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏°‡∏µ‡πÅ‡∏™‡∏á‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠'
  };
  return questions[qName] || qName;
}

// Get section info
function getQuestionSection(qName) {
  const num = parseInt(qName.substring(1));
  if (num >= 1 && num <= 4) return { title: '‡∏Ñ‡∏£‡∏π - ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤ (Verbal Behaviors)', icon: 'üë®‚Äçüè´', color: '#2E3094' };
  if (num >= 5 && num <= 9) return { title: '‡∏Ñ‡∏£‡∏π - ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏†‡∏≤‡∏©‡∏≤ (Non-Verbal Behavior)', icon: 'üé≠', color: '#2E3094' };
  if (num >= 10 && num <= 15) return { title: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', icon: 'üë®‚Äçüéì', color: '#FBB425' };
  if (num >= 16 && num <= 18) return { title: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô - ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', icon: 'üìö', color: '#FBB425' };
  if (num >= 19 && num <= 26) return { title: '‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ - ‡∏™‡∏†‡∏≤‡∏û‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', icon: 'üè´', color: '#28a745' };
  return { title: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', icon: 'üìù', color: '#6c757d' };
}

// Get rating text
function getRatingText(score) {
  const ratings = {
    1: '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á',
    2: '‡∏û‡∏≠‡πÉ‡∏ä‡πâ',
    3: '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á',
    4: '‡∏î‡∏µ',
    5: '‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î'
  };
  return ratings[score] || '-';
}

// Get rating color
function getRatingColor(score) {
  const colors = {
    1: '#dc3545',
    2: '#fd7e14',
    3: '#ffc107',
    4: '#28a745',
    5: '#2E3094'
  };
  return colors[score] || '#6c757d';
}

// View evaluation details
function viewEvaluationDetails(evalNum) {
  const evalData = currentEvalPeriod.evaluations[evalNum];
  if (!evalData || !evalData.answers) {
    Swal.fire({
      icon: 'warning',
      title: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
      text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ',
      confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö'
    });
    return;
  }

  // Set modal title and date
  document.getElementById('detailsEvalTitle').textContent = `‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${evalNum}`;
  document.getElementById('detailsEvalDate').textContent = formatThaiDate(evalData.date);

  // Build details content
  let html = '';
  const answers = evalData.answers;
  const totalQuestions = Object.keys(answers).length;
  
  // Calculate average score
  let totalScore = 0;
  Object.values(answers).forEach(score => totalScore += parseInt(score));
  const avgScore = totalQuestions > 0 ? (totalScore / totalQuestions).toFixed(2) : 0;
  
  // Summary card
  html += `
    <div style="background:var(--color-primary);color:white;padding:24px;border-radius:12px;margin-bottom:24px;box-shadow:0 4px 12px rgba(0,0,0,0.15)">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;text-align:center">
        <div>
          <div style="font-size:2.5rem;font-weight:700;margin-bottom:4px">${totalQuestions}</div>
          <div style="font-size:0.9rem;opacity:0.9">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö</div>
        </div>
        <div>
          <div style="font-size:2.5rem;font-weight:700;margin-bottom:4px">${avgScore}</div>
          <div style="font-size:0.9rem;opacity:0.9">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
        </div>
        <div>
          <div style="font-size:2.5rem;font-weight:700;margin-bottom:4px">${evalData.submitted ? '‚úÖ' : '‚è≥'}</div>
          <div style="font-size:0.9rem;opacity:0.9">${evalData.submitted ? '‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡πà‡∏á'}</div>
        </div>
      </div>
    </div>
  `;

  // Group answers by section
  const sections = {};
  Object.keys(answers).forEach(qName => {
    const section = getQuestionSection(qName);
    if (!sections[section.title]) {
      sections[section.title] = { ...section, questions: [] };
    }
    sections[section.title].questions.push({
      name: qName,
      text: getQuestionText(qName),
      score: answers[qName]
    });
  });

  // Display by sections
  Object.values(sections).forEach(section => {
    html += `
      <div style="margin-bottom:32px;background:var(--color-surface);border-radius:12px;overflow:hidden;border:2px solid var(--color-border)">
        <div style="background:${section.color};color:white;padding:16px;display:flex;align-items:center;gap:12px">
          <span style="font-size:1.5rem">${section.icon}</span>
          <h4 style="margin:0;font-size:1.1rem">${section.title}</h4>
        </div>
        <div style="padding:20px">
    `;
    
    section.questions.forEach((q, idx) => {
      const ratingText = getRatingText(q.score);
      const ratingColor = getRatingColor(q.score);
      
      html += `
        <div style="padding:16px;background:var(--color-bg);border-radius:8px;margin-bottom:${idx < section.questions.length - 1 ? '12px' : '0'}">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:16px;flex-wrap:wrap">
            <div style="flex:1;min-width:250px">
              <div style="font-weight:500;color:var(--color-text);margin-bottom:8px">
                ${q.text}
              </div>
            </div>
            <div style="display:flex;align-items:center;gap:12px">
              <div style="text-align:center">
                <div style="font-size:1.8rem;font-weight:700;color:${ratingColor}">${q.score}</div>
                <div style="font-size:0.75rem;color:var(--color-muted);margin-top:2px">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
              </div>
              <div style="background:${ratingColor};color:white;padding:8px 16px;border-radius:20px;font-weight:600;font-size:0.9rem">
                ${ratingText}
              </div>
            </div>
          </div>
        </div>
      `;
    });
    
    html += '</div></div>';
  });

  document.getElementById('detailsContent').innerHTML = html;
  document.getElementById('evaluationDetailsModal').style.display = 'flex';
}

function closeDetailsModal() {
  document.getElementById('evaluationDetailsModal').style.display = 'none';
}

// Check if within practice period
function isWithinPracticePeriod() {
  const now = new Date();
  const start = new Date(currentEvalPeriod.startDate);
  const end = new Date(currentEvalPeriod.endDate);
  return now >= start && now <= end;
}

// Format Thai date
function formatThaiDate(dateStr) {
  if (!dateStr) return '-';
  const d = new Date(dateStr);
  const thaiMonths = ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.', '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];
  return `${d.getDate()} ${thaiMonths[d.getMonth()]} ${d.getFullYear() + 543}`;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  // Initial load
  changeEvalPeriod();

  // Setup main lesson plan upload handler
  const mainLessonPlanInput = document.getElementById('mainLessonPlanInput');
  if (mainLessonPlanInput) {
    mainLessonPlanInput.addEventListener('change', handleMainLessonPlanUpload);
  }
});

// Handle main lesson plan file upload
function handleMainLessonPlanUpload(e) {
  const file = e.target.files[0];
  if (!file) return;

  // Check file size (20MB = 20 * 1024 * 1024 bytes)
  const maxSize = 20 * 1024 * 1024;
  if (file.size > maxSize) {
    Swal.fire({
      icon: 'error',
      title: '‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ',
      text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 20MB',
      confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö'
    });
    e.target.value = '';
    return;
  }

  // Check file type
  const allowedTypes = [
    'application/pdf',
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/vnd.ms-powerpoint',
    'application/vnd.openxmlformats-officedocument.presentationml.presentation'
  ];
  
  if (!allowedTypes.includes(file.type)) {
    Swal.fire({
      icon: 'error',
      title: '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
      text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF, Word ‡∏´‡∏£‡∏∑‡∏≠ PowerPoint ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
      confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö'
    });
    e.target.value = '';
    return;
  }

  // Store file
  mainLessonPlanFile = file;

  // Update file name display
  document.getElementById('mainLessonPlanFileName').textContent = file.name;
  document.getElementById('mainLessonPlanFileName').style.color = 'var(--color-primary)';
  
  // Enable submit button
  document.getElementById('submitLessonPlanBtn').disabled = false;

  // Show preview
  showMainLessonPlanPreview(file);
}

// Show main lesson plan preview
function showMainLessonPlanPreview(file) {
  const previewDiv = document.getElementById('mainLessonPlanPreview');
  const contentDiv = document.getElementById('mainLessonPlanPreviewContent');
  
  previewDiv.style.display = 'block';

  // Get file icon based on type
  let icon = 'üìÑ';
  if (file.type.includes('pdf')) icon = 'üìï';
  else if (file.type.includes('word')) icon = 'üìò';
  else if (file.type.includes('presentation')) icon = 'üìô';

  const fileSizeKB = (file.size / 1024).toFixed(2);
  const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
  const displaySize = file.size > 1024 * 1024 ? `${fileSizeMB} MB` : `${fileSizeKB} KB`;

  contentDiv.innerHTML = `
    <div style="display:flex;align-items:center;gap:16px;padding:12px;background:var(--color-bg);border-radius:6px">
      <div style="font-size:3rem">${icon}</div>
      <div style="flex:1">
        <div style="font-weight:600;color:var(--color-text);margin-bottom:4px">${file.name}</div>
        <div style="font-size:0.85rem;color:var(--color-muted)">
          ‡∏Ç‡∏ô‡∏≤‡∏î: ${displaySize} | ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${getFileTypeName(file.type)}
        </div>
        <div style="margin-top:8px">
          <span style="background:#d4edda;color:#155724;padding:4px 12px;border-radius:12px;font-size:0.8rem;font-weight:500">
            ‚úì ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á
          </span>
        </div>
      </div>
    </div>
  `;

  // For PDF files, show embedded preview
  if (file.type === 'application/pdf') {
    const reader = new FileReader();
    reader.onload = function(e) {
      contentDiv.innerHTML += `
        <div style="margin-top:16px;border:1px solid var(--color-border);border-radius:8px;overflow:hidden">
          <div style="background:var(--color-bg);padding:8px;font-weight:500;font-size:0.9rem">
            ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á PDF:
          </div>
          <iframe src="${e.target.result}" style="width:100%;height:400px;border:none"></iframe>
        </div>
      `;
    };
    reader.readAsDataURL(file);
  }
}

// Get file type display name
function getFileTypeName(mimeType) {
  const types = {
    'application/pdf': 'PDF',
    'application/msword': 'Word (DOC)',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'Word (DOCX)',
    'application/vnd.ms-powerpoint': 'PowerPoint (PPT)',
    'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'PowerPoint (PPTX)'
  };
  return types[mimeType] || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó';
}

// Remove main lesson plan
function removeMainLessonPlan() {
  mainLessonPlanFile = null;
  document.getElementById('mainLessonPlanInput').value = '';
  document.getElementById('mainLessonPlanFileName').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
  document.getElementById('mainLessonPlanFileName').style.color = 'var(--color-muted)';
  document.getElementById('mainLessonPlanPreview').style.display = 'none';
  document.getElementById('submitLessonPlanBtn').disabled = true;
  
  Swal.fire({
    icon: 'success',
    title: '‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
    timer: 1500,
    showConfirmButton: false
  });
}

function loadEvaluationStates() {
  // Update UI for each evaluation from current period
  for (let i = 1; i <= 9; i++) {
    const evalInfo = currentEvalPeriod.evaluations[i];
    const statusEl = document.getElementById(`status-${i}`);
    const dateEl = document.querySelector(`#date-${i} .date-value`);
    const btnEl = document.querySelector(`button[data-eval="${i}"]`);

    if (!statusEl || !dateEl || !btnEl) continue;

    if (evalInfo) {
      dateEl.textContent = formatThaiDate(evalInfo.date);
      
      if (evalInfo.submitted) {
        statusEl.className = 'eval-status completed';
        statusEl.innerHTML = '<span class="status-icon">‚úÖ</span><span class="status-text">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>';
        btnEl.textContent = '‡∏î‡∏π‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô';
        btnEl.disabled = false;
      } else {
        statusEl.className = 'eval-status pending';
        statusEl.innerHTML = '<span class="status-icon">‚è≥</span><span class="status-text">‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</span>';
        btnEl.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô';
        btnEl.disabled = false;
      }
    } else {
      statusEl.className = 'eval-status pending';
      statusEl.innerHTML = '<span class="status-icon">‚è≥</span><span class="status-text">‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</span>';
      dateEl.textContent = '-';
      btnEl.textContent = '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô';
      btnEl.disabled = false;
    }
  }
}

function startEvaluation(evalNum) {
  currentEvalNum = evalNum;
  
  // Check if outside practice period
  if (!isWithinPracticePeriod()) {
    Swal.fire({
      icon: 'error',
      title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ',
      text: '‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ù‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ô‡∏¥‡πÄ‡∏ó‡∏®',
      confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö'
    });
    return;
  }

  // Check if already submitted
  const evalInfo = currentEvalPeriod.evaluations[evalNum];
  if (evalInfo && evalInfo.submitted) {
    // View mode
    viewEvaluation(evalNum);
    return;
  }

  // Set current date if first time
  if (!evalInfo) {
    currentEvalPeriod.evaluations[evalNum] = {
      date: new Date().toISOString().split('T')[0],
      answers: {},
      submitted: false
    };
    saveEvaluationData();
    loadEvaluationStates();
  }

  // Open modal
  document.getElementById('evalTitle').textContent = `‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${evalNum}`;
  document.getElementById('modalEvalDate').textContent = formatThaiDate(currentEvalPeriod.evaluations[evalNum].date);
  
  // Load saved answers if any
  const form = document.getElementById('evaluationForm');
  form.reset();
  if (evalInfo && evalInfo.answers) {
    Object.keys(evalInfo.answers).forEach(qName => {
      const radio = form.querySelector(`input[name="${qName}"][value="${evalInfo.answers[qName]}"]`);
      if (radio) radio.checked = true;
    });
  }

  document.getElementById('evaluationModal').style.display = 'flex';
}

function viewEvaluation(evalNum) {
  currentEvalNum = evalNum;
  const evalInfo = currentEvalPeriod.evaluations[evalNum];
  if (!evalInfo) return;

  // Populate modal with saved data
  document.getElementById('evalTitle').textContent = `‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${evalNum}`;
  document.getElementById('modalEvalDate').textContent = formatThaiDate(evalInfo.date);

  const form = document.getElementById('evaluationForm');
  if (form) form.reset();
  if (evalInfo.answers && form) {
    Object.keys(evalInfo.answers).forEach(qName => {
      const radio = form.querySelector(`input[name="${qName}"][value="${evalInfo.answers[qName]}"]`);
      if (radio) radio.checked = true;
    });
  }

  // Open modal in view-only mode
  document.getElementById('evaluationModal').style.display = 'flex';
  document.querySelectorAll('#evaluationForm input').forEach(input => input.disabled = true);
  const submitBtn = document.querySelector('.modal-footer .btn--primary');
  if (submitBtn) submitBtn.style.display = 'none';
}

function closeEvaluationModal() {
  // Save progress before closing (if not submitted)
  if (currentEvalNum && currentEvalPeriod.evaluations[currentEvalNum] && !currentEvalPeriod.evaluations[currentEvalNum].submitted) {
    saveProgress();
  }
  document.getElementById('evaluationModal').style.display = 'none';
  currentEvalNum = null;
  
  // Re-enable inputs for next time
  document.querySelectorAll('#evaluationForm input').forEach(input => input.disabled = false);
  const submitBtn = document.querySelector('.modal-footer .btn--primary');
  if (submitBtn) submitBtn.style.display = 'block';
}

function saveProgress() {
  const form = document.getElementById('evaluationForm');
  const formData = new FormData(form);
  const answers = {};
  
  for (let [key, value] of formData.entries()) {
    answers[key] = value;
  }
  
  currentEvalPeriod.evaluations[currentEvalNum].answers = answers;
  saveEvaluationData();
}

function submitEvaluation() {
  const form = document.getElementById('evaluationForm');
  
  // Validate all questions answered
  const totalQuestions = 26;
  const answeredQuestions = new FormData(form).entries();
  const count = Array.from(answeredQuestions).length;
  
  if (count < totalQuestions) {
    Swal.fire({
      icon: 'warning',
      title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö',
      text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ${count} ‡∏à‡∏≤‡∏Å ${totalQuestions} ‡∏Ç‡πâ‡∏≠`,
      confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö'
    });
    return;
  }



  // Confirm submission
  Swal.fire({
    icon: 'question',
    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô',
    html: `
      <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô<strong>‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${currentEvalNum}</strong> ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
      <p style="color:var(--color-danger);margin-top:12px">
        <strong>‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
      </p>
    `,
    showCancelButton: true,
    confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á',
    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
    confirmButtonColor: '#2E3094',
    cancelButtonColor: '#6c757d'
  }).then((result) => {
    if (result.isConfirmed) {
      // Save and mark as submitted
      saveProgress();
      
      currentEvalPeriod.evaluations[currentEvalNum].submitted = true;
      saveEvaluationData();
      loadEvaluationStates();
      showSuccessAndClose();
    }
  });
}

function showSuccessAndClose() {
  Swal.fire({
    icon: 'success',
    title: '‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
    text: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà ${currentEvalNum} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`,
    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
  }).then(() => {
    // Close modal and clear form content (answers preserved in evaluationData)
    const form = document.getElementById('evaluationForm');
    if (form) form.reset();
    closeEvaluationModal();
  });
}

// Load lesson plan status
function loadLessonPlanStatus() {
  const statusDiv = document.getElementById('lessonPlanStatus');
  const statusText = document.getElementById('lessonPlanStatusText');
  const fileNameEl = document.getElementById('mainLessonPlanFileName');
  const submitBtn = document.getElementById('submitLessonPlanBtn');
  
  if (!statusDiv || !statusText) return;
  
  if (currentEvalPeriod.lessonPlan && currentEvalPeriod.lessonPlan.uploaded) {
    statusDiv.style.display = 'block';
    statusDiv.style.background = '#d4edda';
    statusDiv.style.color = '#155724';
    statusText.textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (${formatThaiDate(currentEvalPeriod.lessonPlan.submittedDate)})`;
    
    if (fileNameEl) {
      fileNameEl.textContent = currentEvalPeriod.lessonPlan.fileName;
      fileNameEl.style.color = 'var(--color-success)';
    }
    if (submitBtn) {
      submitBtn.textContent = '‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß';
      submitBtn.disabled = true;
    }
  } else {
    statusDiv.style.display = 'block';
    statusText.textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ';
    if (fileNameEl) {
      fileNameEl.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
      fileNameEl.style.color = 'var(--color-muted)';
    }
    if (submitBtn) {
      submitBtn.textContent = 'üì§ ‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ';
      submitBtn.disabled = !mainLessonPlanFile;
    }
  }
}

// Submit lesson plan
function submitLessonPlan() {
  if (!mainLessonPlanFile) {
    Swal.fire({
      icon: 'warning',
      title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå',
      text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á',
      confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö'
    });
    return;
  }
  
  // Confirm submission
  Swal.fire({
    icon: 'question',
    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ',
    html: `
      <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
      <p style="color:var(--color-primary);font-weight:600">${mainLessonPlanFile.name}</p>
      <p style="color:var(--color-danger);margin-top:12px">
        <strong>‚ö†Ô∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
      </p>
    `,
    showCancelButton: true,
    confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á',
    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
    confirmButtonColor: '#2E3094',
    cancelButtonColor: '#6c757d'
  }).then((result) => {
    if (result.isConfirmed) {
      // Save lesson plan to current period
      currentEvalPeriod.lessonPlan = {
        uploaded: true,
        fileName: mainLessonPlanFile.name,
        submittedDate: new Date().toISOString().split('T')[0]
      };
      
      // Save to server/localStorage
      saveEvaluationData();
      
      // Update UI
      loadLessonPlanStatus();
      
      Swal.fire({
        icon: 'success',
        title: '‡∏™‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
      });
    }
  });
}

function saveEvaluationData() {
  // Save entire history to localStorage (in production, send to server API)
  localStorage.setItem('evaluationPracticeHistory_' + userYear, JSON.stringify(evaluationPracticeHistory));
  // TODO: Also send to server via API
  // fetch('/api/evaluation/save', { method: 'POST', body: JSON.stringify(currentEvalPeriod) })
}

// Disable form when pure admin, no practice or no active
document.addEventListener('DOMContentLoaded', function() {
  if (isPureAdminClient) {
    // Pure admin - disable all interactions
    document.querySelectorAll('input, select, button, textarea').forEach(el => {
      if (!el.classList.contains('modal-close')) el.disabled = true;
    });
  } else if (!hasPractice || !hasActive) {
    const currentContent = document.getElementById('evalCurrentContent');
    if (currentContent) {
      // Disable all inputs, textareas, and buttons in current content area
      currentContent.querySelectorAll('input,textarea,button').forEach(el => {
        el.disabled = true;
      });
    }
  }
});

// Close modal when clicking outside
document.getElementById('evaluationModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeEvaluationModal();
  }
});

document.getElementById('evaluationDetailsModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeDetailsModal();
  }
});
</script>
