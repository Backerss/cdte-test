<%
  // Use server-provided mentor practice history. Server should pass `mentorPracticeHistory` and optionally `activeMentorPeriodId`.
  const mentorPractice = (typeof mentorPracticeHistory !== 'undefined' && Array.isArray(mentorPracticeHistory))
    ? mentorPracticeHistory
    : [];

  const activeMentorPeriod = (typeof activeMentorPeriodId !== 'undefined')
    ? mentorPractice.find(p => p.id === activeMentorPeriodId)
    : mentorPractice.find(p => p.status === 'active');

  const currentMentorData = activeMentorPeriod && activeMentorPeriod.mentorData;
  const hasPractice = mentorPractice.length > 0;
  const hasActive = !!activeMentorPeriod;

  // Check if user is pure admin (admin role without student ID)
  const isPureAdmin = user && user.role === 'admin' && !user.studentId;
%>

<div class="page-content">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:24px;gap:16px;flex-wrap:wrap">
      <div>
        <h2 style="margin:0 0 8px 0;color:var(--color-primary);display:flex;align-items:center;gap:12px">
          <span>üë®‚Äçüè´</span>
          ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á
        </h2>
        <p class="text-muted" style="margin:0">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</p>
      </div>
      
      <div class="form-group" style="margin:0;min-width:300px">
        <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏á‡∏ß‡∏î‡∏ù‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå</label>
        <select id="mentorPeriodSelector" class="form-input" onchange="changeMentorPeriod()" style="padding:10px 14px">
          <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
        </select>
      </div>
    </div>

    <% if (isPureAdmin) { %>
      <div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <span style="font-size: 1.5rem;">üîí</span>
          <h3 style="margin: 0; font-size: 1.2rem;">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</h3>
        </div>
        <p style="margin: 0; font-size: 1rem; line-height: 1.5; opacity: 0.95;">‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞ <strong>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</strong> ‡∏ã‡∏∂‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÑ‡∏î‡πâ<br>‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</p>
      </div>
    <% } else if (!hasActive) { %>
      <div id="noMentorActiveBanner" style="background:#fff3cd;border-left:4px solid #ffc107;padding:12px;border-radius:8px;margin-bottom:16px;color:#856404">
        ‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ß‡∏î‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" ‚Äî ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ß‡∏î‡∏ù‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà
      </div>
    <% } %>

    <!-- ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤ (Read-only) -->
    <div id="mentorHistoryView" style="display:none">
      <div style="background:rgba(251,180,37,0.1);border-left:4px solid var(--color-secondary);padding:16px;border-radius:8px;margin-bottom:24px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
          <span style="font-size:1.3rem">üìö</span>
          <strong style="color:var(--color-text);font-size:1.1rem">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (Read-Only)</strong>
        </div>
        <p style="margin:0;color:var(--color-muted);font-size:0.9rem">
          ‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏á‡∏ß‡∏î‡∏ù‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ
        </p>
      </div>
      <div id="mentorHistoryContent" class="readonly-form"></div>
    </div>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏ß‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Editable) -->
    <% if (!isPureAdmin) { %>
    <form id="mentorCurrentForm" class="dashboard-form" style="margin-top:24px" onsubmit="return saveMentorInfo(event)">
      <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏Å‡πà‡∏≤ -->
      <div style="background:var(--color-bg);border:2px dashed var(--color-border);padding:16px;border-radius:10px;margin-bottom:24px">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
              <span style="font-size:1.3rem">üí°</span>
              <strong style="color:var(--color-text)">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏á‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</strong>
            </div>
            <p style="margin:0;color:var(--color-muted);font-size:0.9rem">
              ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ù‡∏∂‡∏Å‡∏ó‡∏µ‡πà‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏π‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ
            </p>
          </div>
          <button type="button" class="btn btn--secondary" onclick="showMentorHistoryModal()" style="white-space:nowrap">
            üìã ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
          </button>
        </div>
      </div>

      <!-- Personal Information -->
      <div class="form-section">
      <!-- Personal Information -->
      <div class="form-section">
        <h3 class="form-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="form-group">
            <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠ <span class="required">*</span></label>
            <input type="text" class="form-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠" required>
          </div>
          <div class="form-group">
            <label class="form-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="required">*</span></label>
            <input type="text" class="form-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞ <span class="required">*</span></label>
          <select class="form-input" required>
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞</option>
            <option value="‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢</option>
            <option value="‡∏Ñ‡∏£‡∏π (‡∏Ñ‡∏®.1)">‡∏Ñ‡∏£‡∏π (‡∏Ñ‡∏®.1)</option>
            <option value="‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏®.2)">‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏®.2)</option>
            <option value="‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏Ñ‡∏®.3)">‡∏Ñ‡∏£‡∏π‡∏ä‡∏≥‡∏ô‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏Ñ‡∏®.3)</option>
            <option value="‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç (‡∏Ñ‡∏®.4)">‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç (‡∏Ñ‡∏®.4)</option>
            <option value="‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏Ñ‡∏®.5)">‡∏Ñ‡∏£‡∏π‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏Ñ‡∏®.5)</option>
          </select>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="form-group">
            <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input type="tel" class="form-input" placeholder="0X-XXXX-XXXX">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
            <input type="email" class="form-input" placeholder="mentor@nsru.ac.th">
          </div>
        </div>
      </div>

      <!-- Education -->
      <div class="form-section">
        <h3 class="form-section-title">‡∏ß‡∏∏‡∏í‡∏¥‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
        
        <div id="educationContainer">
          <div class="education-entry" style="display:flex;gap:8px;align-items:flex-end;margin-bottom:12px">
            <div class="form-group" style="flex:1;margin:0">
              <label class="form-label">‡∏ß‡∏∏‡∏í‡∏¥‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
              <input type="text" class="form-input education-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ.‡∏ö. ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
            </div>
            <button type="button" class="btn btn--danger btn--icon" onclick="removeEducation(this)" style="padding:10px 16px">
              ‚úï
            </button>
          </div>
        </div>
        
        <button type="button" class="btn btn--secondary" onclick="addEducation()" style="margin-top:8px">
          ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏∏‡∏í‡∏¥‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
        </button>
      </div>

      <!-- Teaching Experience -->
      <div class="form-section">
        <h3 class="form-section-title">‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h3>
        
        <div class="form-group">
          <label class="form-label">‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ / ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô (‡∏õ‡∏µ)</label>
          <input type="number" class="form-input" placeholder="0" min="0" max="50">
        </div>

        <div class="form-group">
          <label class="form-label">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label>
          <select class="form-input">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</option>
            <option value="‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢">‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</option>
            <option value="‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå">‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
            <option value="‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ</option>
            <option value="‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°">‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°</option>
            <option value="‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
            <option value="‡∏®‡∏¥‡∏•‡∏õ‡∏∞">‡∏®‡∏¥‡∏•‡∏õ‡∏∞</option>
            <option value="‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û">‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</option>
            <option value="‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®">‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</option>
          </select>
        </div>
      </div>

      <!-- Teaching Subjects & Grades -->
      <div class="form-section">
        <h3 class="form-section-title">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô / ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</h3>
        
        <div class="form-group">
          <label class="form-label">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô</label>
          <div class="teaching-input">
            <input type="text" 
                   id="teachingDisplay" 
                   class="form-input" 
                   placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô" 
                   readonly 
                   style="cursor:pointer"
                   onclick="openTeachingModal()">
            <button type="button" 
                    class="teaching-btn" 
                    onclick="openTeachingModal()"
                    style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--color-primary);cursor:pointer;font-size:1.2rem">
              ‚öôÔ∏è
            </button>
          </div>
          <div id="teachingTags" class="teaching-tags" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px"></div>
        </div>
      </div>

      <div class="form-actions" style="margin-top:32px;display:flex;gap:12px">
        <button type="submit" class="btn btn--primary">
          üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
        <button type="reset" class="btn btn--secondary">
          üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
        </button>
      </div>
    </form>
    <% } %>
  </div>
</div>

<!-- Modal: Select Mentor from History -->
<div id="mentorHistoryModal" class="modal-overlay" style="display:none">
  <div class="modal-content" style="max-width:700px">
    <div class="modal-header">
      <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</h3>
      <button type="button" class="modal-close" onclick="closeMentorHistoryModal()">√ó</button>
    </div>
    
    <div class="modal-body">
      <p style="color:var(--color-muted);margin:0 0 20px 0;font-size:0.95rem">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏î‡∏π‡πÅ‡∏•‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏á‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      </p>
      
      <div id="mentorHistoryList" class="mentor-history-list">
        <% mentorPractice.filter(p => p.mentorData && p.status !== 'active').forEach((record) => { %>
          <div class="mentor-card" onclick="selectMentorFromHistory(<%= record.id %>)">
            <div class="mentor-card-header">
              <div style="display:flex;align-items:center;gap:12px">
                <div class="mentor-avatar">üë®‚Äçüè´</div>
                <div>
                  <h4 style="margin:0 0 4px 0;color:var(--color-primary);font-size:1.1rem">
                    <%= record.mentorData.firstName %> <%= record.mentorData.lastName %>
                  </h4>
                  <p style="margin:0;font-size:0.85rem;color:var(--color-muted)">
                    <%= record.mentorData.position %>
                  </p>
                </div>
              </div>
              <span class="period-badge">
                <%= record.period %>
              </span>
            </div>
            
            <div class="mentor-card-body">
              <div class="mentor-info-row">
                <span class="mentor-info-label">üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</span>
                <span><%= record.mentorData.phone %></span>
              </div>
              <div class="mentor-info-row">
                <span class="mentor-info-label">üìß ‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</span>
                <span><%= record.mentorData.email %></span>
              </div>
              <div class="mentor-info-row">
                <span class="mentor-info-label">üëî ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞:</span>
                <span><%= record.mentorData.department %></span>
              </div>
              <div class="mentor-info-row">
                <span class="mentor-info-label">‚è±Ô∏è ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå:</span>
                <span><%= record.mentorData.experience %> ‡∏õ‡∏µ</span>
              </div>
            </div>
            
            <div class="mentor-card-footer">
              <button type="button" class="btn-select-mentor">
                ‚úì ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏£‡∏π‡∏ó‡πà‡∏≤‡∏ô‡∏ô‡∏µ‡πâ
              </button>
            </div>
          </div>
        <% }); %>
      </div>
      
      <% if (mentorPractice.filter(p => p.mentorData && p.status !== 'active').length === 0) { %>
        <div style="text-align:center;padding:40px;color:var(--color-muted)">
          <div style="font-size:3rem;margin-bottom:16px">üìã</div>
          <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏π‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏á‡∏ß‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</p>
        </div>
      <% } %>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn btn--secondary" onclick="closeMentorHistoryModal()">
        ‡∏õ‡∏¥‡∏î
      </button>
    </div>
  </div>
</div>

<!-- Teaching Subject & Grade Selection Modal -->
<div id="teachingModal" class="modal-overlay" style="display:none">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô</h3>
      <button type="button" class="modal-close" onclick="closeTeachingModal()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</label>
        <input type="text" id="subjectNameInput" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô">
      </div>

      <div class="teaching-selection">
        <h4 style="margin:16px 0 12px 0;color:var(--color-text)">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ</h4>
        <div class="grade-category">
          <h4>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•</h4>
          <div class="checkbox-grid">
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏≠.1">
              <span>‡∏≠.1</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏≠.2">
              <span>‡∏≠.2</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏≠.3">
              <span>‡∏≠.3</span>
            </label>
          </div>
        </div>
        <div class="grade-category">
          <h4>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h4>
          <div class="checkbox-grid">
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏õ.1">
              <span>‡∏õ.1</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏õ.2">
              <span>‡∏õ.2</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏õ.3">
              <span>‡∏õ.3</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏õ.4">
              <span>‡∏õ.4</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏õ.5">
              <span>‡∏õ.5</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏õ.6">
              <span>‡∏õ.6</span>
            </label>
          </div>
        </div>

        <div class="grade-category">
          <h4>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô</h4>
          <div class="checkbox-grid">
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏°.1">
              <span>‡∏°.1</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏°.2">
              <span>‡∏°.2</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏°.3">
              <span>‡∏°.3</span>
            </label>
          </div>
        </div>

        <div class="grade-category">
          <h4>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢</h4>
          <div class="checkbox-grid">
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏°.4">
              <span>‡∏°.4</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏°.5">
              <span>‡∏°.5</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏°.6">
              <span>‡∏°.6</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn--secondary" onclick="closeTeachingModal()">
        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
      </button>
      <button type="button" class="btn btn--primary" onclick="addTeachingSubject()">
        ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤
      </button>
    </div>
  </div>
</div>

<style>
.form-section {
  margin-bottom: 32px;
  padding-bottom: 24px;
  border-bottom: 1px solid var(--color-border);
}

.form-section:last-of-type {
  border-bottom: none;
  margin-bottom: 0;
}

.form-section-title {
  color: var(--color-primary);
  font-size: 1.2rem;
  font-weight: 600;
  margin: 0 0 20px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.form-section-title::before {
  content: '';
  width: 4px;
  height: 20px;
  background: var(--color-primary);
  border-radius: 2px;
}

.required {
  color: var(--color-danger);
  font-weight: 600;
}

.teaching-input {
  position: relative;
}

.teaching-btn {
  transition: color 0.2s ease;
}

.teaching-btn:hover {
  color: var(--color-secondary) !important;
}

.teaching-tags {
  min-height: 20px;
}

.teaching-tag {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--color-primary);
  color: white;
  padding: 6px 12px;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 500;
}

.teaching-tag-remove {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  font-size: 0.9rem;
  padding: 0;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s ease;
}

.teaching-tag-remove:hover {
  background: rgba(255, 255, 255, 0.2);
}

.btn--icon {
  padding: 10px 16px;
  min-width: auto;
}

.btn--danger {
  background: var(--color-danger);
  color: white;
}

.btn--danger:hover {
  background: #c0392b;
}

/* Modal Styles */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: var(--color-surface);
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid var(--color-border);
}

.modal-header h3 {
  margin: 0;
  color: var(--color-text);
  font-size: 1.25rem;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--color-muted);
  padding: 4px;
  border-radius: 4px;
  transition: color 0.2s ease;
}

.modal-close:hover {
  color: var(--color-danger);
}

.modal-body {
  padding: 24px;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 20px 24px;
  border-top: 1px solid var(--color-border);
}

.grade-category {
  margin-bottom: 24px;
}

.grade-category h4 {
  color: var(--color-text);
  font-size: 1rem;
  font-weight: 600;
  margin: 0 0 12px 0;
}

.checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
  gap: 8px;
}

.checkbox-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border: 1px solid var(--color-border);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.checkbox-item:hover {
  border-color: var(--color-primary);
  background: var(--color-bg);
}

.checkbox-item input[type="checkbox"] {
  margin: 0;
}

.checkbox-item input[type="checkbox"]:checked + span {
  color: var(--color-primary);
  font-weight: 600;
}

.btn--secondary {
  background: var(--color-muted);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: background 0.2s ease;
}

.btn--secondary:hover {
  background: var(--color-text);
}

/* Mentor History Modal Styles */
.mentor-history-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-height: 500px;
  overflow-y: auto;
  padding: 4px;
}

.mentor-card {
  background: var(--color-surface);
  border: 2px solid var(--color-border);
  border-radius: 12px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.mentor-card:hover {
  border-color: var(--color-primary);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}

.mentor-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 16px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--color-border);
}

.mentor-avatar {
  width: 50px;
  height: 50px;
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.8rem;
}

.period-badge {
  background: var(--color-primary);
  color: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  white-space: nowrap;
}

.mentor-card-body {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 16px;
}

.mentor-info-row {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.mentor-info-label {
  font-size: 0.8rem;
  color: var(--color-muted);
  font-weight: 500;
}

.mentor-card-footer {
  display: flex;
  justify-content: flex-end;
}

.btn-select-mentor {
  background: var(--color-primary);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-select-mentor:hover {
  background: var(--color-secondary);
  transform: scale(1.05);
}

/* Read-only view styles */
.readonly-form {
  max-width: 100%;
}

.readonly-section {
  margin-bottom: 32px;
  padding: 20px;
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: 10px;
}

.readonly-title {
  color: var(--color-primary);
  font-size: 1.1rem;
  font-weight: 600;
  margin: 0 0 16px 0;
  display: flex;
  align-items: center;
  gap: 8px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--color-border);
}

.readonly-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
}

.readonly-item {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.readonly-item.full-width {
  grid-column: 1 / -1;
}

.readonly-item label {
  font-size: 0.85rem;
  color: var(--color-muted);
  font-weight: 500;
}

.readonly-item div {
  font-size: 1rem;
  color: var(--color-text);
  font-weight: 600;
  padding: 8px 12px;
  background: var(--color-bg);
  border-radius: 6px;
  border: 1px solid var(--color-border);
}

.grade-tag-readonly {
  display: inline-block;
  background: var(--color-primary);
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 600;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/observation-utils.js"></script>
<script src="/js/mentor-info.js"></script>
<script>
// `teachingSubjects` is defined in `/public/js/mentor-info.js` to avoid duplicate-let errors.

// Education Management
function addEducation() {
  const container = document.getElementById('educationContainer');
  const entry = document.createElement('div');
  entry.className = 'education-entry';
  entry.style.cssText = 'display:flex;gap:8px;align-items:flex-end;margin-bottom:12px';
  entry.innerHTML = `
    <div class="form-group" style="flex:1;margin:0">
      <input type="text" class="form-input education-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ.‡∏ö. ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤">
    </div>
    <button type="button" class="btn btn--danger btn--icon" onclick="removeEducation(this)" style="padding:10px 16px">
      ‚úï
    </button>
  `;
  container.appendChild(entry);
}

function removeEducation(btn) {
  const entries = document.querySelectorAll('.education-entry');
  if (entries.length > 1) {
    btn.closest('.education-entry').remove();
  }
}

// Teaching Modal
function openTeachingModal() {
  document.getElementById('teachingModal').style.display = 'flex';
  document.getElementById('subjectNameInput').value = '';
  document.querySelectorAll('#teachingModal input[type="checkbox"]').forEach(cb => cb.checked = false);
}

function closeTeachingModal() {
  document.getElementById('teachingModal').style.display = 'none';
}

function addTeachingSubject() {
  const subjectName = document.getElementById('subjectNameInput').value.trim();
  if (!subjectName) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤');
    return;
  }

  const selectedGrades = [];
  document.querySelectorAll('#teachingModal input[type="checkbox"]:checked').forEach(cb => {
    selectedGrades.push(cb.value);
  });

  if (selectedGrades.length === 0) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏∞‡∏î‡∏±‡∏ö');
    return;
  }

  // Sort grades properly
  selectedGrades.sort((a, b) => {
    const order = ch => {
      if (ch === '‡∏≠') return 0;
      if (ch === '‡∏õ') return 1;
      if (ch === '‡∏°') return 2;
      return 3;
    };
    const aChar = a.charAt(0);
    const bChar = b.charAt(0);
    const aOrder = order(aChar);
    const bOrder = order(bChar);
    if (aOrder !== bOrder) return aOrder - bOrder;

    const aNum = parseInt(a.replace(/[^0-9]/g, '')) || 0;
    const bNum = parseInt(b.replace(/[^0-9]/g, '')) || 0;
    return aNum - bNum;
  });

  teachingSubjects.push({
    subject: subjectName,
    grades: selectedGrades
  });

  updateTeachingDisplay();
  closeTeachingModal();
}

function updateTeachingDisplay() {
  const display = document.getElementById('teachingDisplay');
  const tagsContainer = document.getElementById('teachingTags');
  
  display.value = teachingSubjects.length > 0 
    ? `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${teachingSubjects.length} ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤` 
    : '';
  
  tagsContainer.innerHTML = '';
  teachingSubjects.forEach((item, index) => {
    const tag = document.createElement('span');
    tag.className = 'teaching-tag';
    tag.innerHTML = `
      <strong>${item.subject}</strong> (${item.grades.join(', ')})
      <button type="button" class="teaching-tag-remove" onclick="removeTeachingSubject(${index})">√ó</button>
    `;
    tagsContainer.appendChild(tag);
  });
}

function removeTeachingSubject(index) {
  teachingSubjects.splice(index, 1);
  updateTeachingDisplay();
}

// Mentor period management (will be loaded from API)
const isPureAdminClient = <%= isPureAdmin ? 'true' : 'false' %>;

// Expose server-side flags to client JS
const hasPractice = <%= hasPractice ? 'true' : 'false' %>;
const hasActive = <%= hasActive ? 'true' : 'false' %>;

// Expose mentor practice data and current/active period id to client
let mentorData = <%- JSON.stringify(mentorPractice || []) %>;
let currentMentorPeriodId = <%- JSON.stringify((typeof activeMentorPeriodId !== 'undefined') ? activeMentorPeriodId : (activeMentorPeriod ? activeMentorPeriod.id : null)) %>;

function changeMentorPeriod() {
  const selector = document.getElementById('mentorPeriodSelector');
  const selectedId = selector.value;
  currentMentorPeriodId = selectedId;
  let selectedPeriod = null;
  const nowMs = Date.now();

  // Helper to get ms from various date formats (Firestore Timestamp or ISO string)
  const getMillis = (val) => {
    try {
      if (!val) return null;
      if (typeof val.toDate === 'function') return val.toDate().getTime();
      if (val._seconds) return val._seconds * 1000;
      if (typeof val === 'string') return new Date(val).getTime();
      return null;
    } catch (e) {
      return null;
    }
  };

  // Try ObservationUtils first (handles latest API data)
  if (window.ObservationUtils && typeof ObservationUtils.getObservationById === 'function') {
    try {
      selectedPeriod = ObservationUtils.getObservationById(selectedId) || ObservationUtils.data.all.find(o => String(o.id) === String(selectedId));
    } catch (err) {
      console.warn('ObservationUtils error', err);
    }
  }

  // Fallback to server-provided mentorData
  if (!selectedPeriod) {
    selectedPeriod = mentorData.find(p => String(p.id) === String(selectedId));
  }

  if (!selectedPeriod) {
    console.warn('Observation/mentor period not found:', selectedId);
    return;
  }

  // Determine active by explicit status OR by date range (fallback)
  const startMs = getMillis(selectedPeriod.startDate || selectedPeriod.start || selectedPeriod.periodStart);
  const endMs = getMillis(selectedPeriod.endDate || selectedPeriod.end || selectedPeriod.periodEnd);
  const withinDates = startMs && endMs ? (nowMs >= startMs && nowMs <= endMs) : false;
  const isActive = selectedPeriod.status === 'active' || withinDates;

  const form = document.getElementById('mentorCurrentForm');

  if (isActive) {
    // Show editable form and enable inputs
    if (form) {
      form.style.display = 'block';
      form.querySelectorAll('input,textarea,select,button').forEach(el => {
        if (!el.classList.contains('modal-close')) el.disabled = false;
      });
    }
    const historyView = document.getElementById('mentorHistoryView');
    if (historyView) historyView.style.display = 'none';

    // Load data into form if available, otherwise reset
    if (selectedPeriod.mentorData) {
      loadMentorDataToForm(selectedPeriod.mentorData);
    } else if (form) {
      form.reset();
      teachingSubjects = [];
      updateTeachingDisplay();
    }
  } else {
    // Show read-only view and disable inputs
    if (form) {
      form.style.display = 'none';
    }
    const historyView = document.getElementById('mentorHistoryView');
    if (historyView) historyView.style.display = 'block';

    if (selectedPeriod.mentorData) {
      displayReadOnlyMentorData(selectedPeriod.mentorData);
    } else {
      const historyContent = document.getElementById('mentorHistoryContent');
      if (historyContent) historyContent.innerHTML = `
        <div style="text-align:center;padding:40px;color:var(--color-muted)">
          <div style="font-size:3rem;margin-bottom:16px">üë®‚Äçüè´</div>
          <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ</p>
        </div>
      `;
    }
  }
}

function loadMentorDataToForm(data) {
  const form = document.getElementById('mentorCurrentForm');
  
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
  const inputs = form.querySelectorAll('input[type="text"]');
  if (inputs[0]) inputs[0].value = data.firstName || '';
  if (inputs[1]) inputs[1].value = data.lastName || '';
  
  // ‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞
  const positionSelect = form.querySelector('select');
  if (positionSelect) {
    // ‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö position
    const options = Array.from(positionSelect.options);
    const matchOption = options.find(opt => opt.text.includes(data.position.split('(')[0].trim()));
    if (matchOption) positionSelect.value = matchOption.value;
  }
  
  // ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•
  const telInput = form.querySelector('input[type="tel"]');
  const emailInput = form.querySelector('input[type="email"]');
  if (telInput) telInput.value = data.phone || '';
  if (emailInput) emailInput.value = data.email || '';
  
  // ‡∏ß‡∏∏‡∏í‡∏¥‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ - ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
  const eduContainer = document.getElementById('educationContainer');
  if (eduContainer && data.education) {
    eduContainer.innerHTML = '';
    data.education.forEach((edu, idx) => {
      if (idx === 0) {
        eduContainer.innerHTML = `
          <div class="education-entry" style="display:flex;gap:8px;align-items:flex-end;margin-bottom:12px">
            <div class="form-group" style="flex:1;margin:0">
              <label class="form-label">‡∏ß‡∏∏‡∏í‡∏¥‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
              <input type="text" class="form-input education-input" value="${edu}">
            </div>
            <button type="button" class="btn btn--danger btn--icon" onclick="removeEducation(this)" style="padding:10px 16px">‚úï</button>
          </div>
        `;
      } else {
        const entry = document.createElement('div');
        entry.className = 'education-entry';
        entry.style.cssText = 'display:flex;gap:8px;align-items:flex-end;margin-bottom:12px';
        entry.innerHTML = `
          <div class="form-group" style="flex:1;margin:0">
            <input type="text" class="form-input education-input" value="${edu}">
          </div>
          <button type="button" class="btn btn--danger btn--icon" onclick="removeEducation(this)" style="padding:10px 16px">‚úï</button>
        `;
        eduContainer.appendChild(entry);
      }
    });
  }
  
  // ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô
  const expInput = form.querySelector('input[type="number"]');
  if (expInput) expInput.value = data.experience || '';
  
  // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞
  const deptSelect = form.querySelectorAll('select')[1];
  if (deptSelect) deptSelect.value = data.department || '';
  
  // ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô
  if (data.teachingSubjects) {
    teachingSubjects = [...data.teachingSubjects];
    updateTeachingDisplay();
  }
}

function displayReadOnlyMentorData(data) {
  const content = document.getElementById('mentorHistoryContent');
  content.innerHTML = `
    <div class="readonly-section">
      <h3 class="readonly-title">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3>
      <div class="readonly-grid">
        <div class="readonly-item">
          <label>‡∏ä‡∏∑‡πà‡∏≠:</label>
          <div>${data.firstName}</div>
        </div>
        <div class="readonly-item">
          <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label>
          <div>${data.lastName}</div>
        </div>
        <div class="readonly-item full-width">
          <label>‡∏ß‡∏¥‡∏ó‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞:</label>
          <div>${data.position}</div>
        </div>
        <div class="readonly-item">
          <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</label>
          <div>${data.phone}</div>
        </div>
        <div class="readonly-item">
          <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</label>
          <div>${data.email}</div>
        </div>
      </div>
    </div>

    <div class="readonly-section">
      <h3 class="readonly-title">üéì ‡∏ß‡∏∏‡∏í‡∏¥‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
      <ul style="margin:0;padding-left:24px;color:var(--color-text)">
        ${data.education.map(edu => `<li style="margin-bottom:8px;font-weight:600">${edu}</li>`).join('')}
      </ul>
    </div>

    <div class="readonly-section">
      <h3 class="readonly-title">üíº ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h3>
      <div class="readonly-grid">
        <div class="readonly-item">
          <label>‡∏≠‡∏≤‡∏¢‡∏∏‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ / ‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå:</label>
          <div>${data.experience} ‡∏õ‡∏µ</div>
        </div>
        <div class="readonly-item">
          <label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</label>
          <div>${data.department}</div>
        </div>
      </div>
    </div>

    <div class="readonly-section">
      <h3 class="readonly-title">üìö ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏ô</h3>
      <div style="display:flex;flex-direction:column;gap:12px">
        ${data.teachingSubjects.map(item => `
          <div style="background:var(--color-bg);padding:12px 16px;border-radius:8px;border:1px solid var(--color-border)">
            <div style="font-weight:700;color:var(--color-primary);margin-bottom:6px">${item.subject}</div>
            <div style="display:flex;flex-wrap:wrap;gap:6px">
              ${item.grades.map(g => `<span class="grade-tag-readonly">${g}</span>`).join('')}
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function showMentorHistoryModal() {
  document.getElementById('mentorHistoryModal').style.display = 'flex';
}

function closeMentorHistoryModal() {
  document.getElementById('mentorHistoryModal').style.display = 'none';
}

function selectMentorFromHistory(periodId) {
  const selectedPeriod = mentorData.find(p => p.id === periodId);
  if (!selectedPeriod || !selectedPeriod.mentorData) return;
  
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°
  loadMentorDataToForm(selectedPeriod.mentorData);
  
  // ‡∏õ‡∏¥‡∏î modal
  closeMentorHistoryModal();
  
  // ‡πÅ‡∏™‡∏î‡∏á notification
  alert(`‚úì ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏π‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏à‡∏≤‡∏Å ${selectedPeriod.period} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!\n\n‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å`);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveMentorInfo ‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏¢‡∏±‡∏á /public/js/mentor-info.js ‡πÅ‡∏•‡πâ‡∏ß
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å external JS file

// Close modal when clicking outside
document.addEventListener('DOMContentLoaded', async function() {
  const teachingModal = document.getElementById('teachingModal');
  if (teachingModal) {
    teachingModal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeTeachingModal();
      }
    });
  }
  
  const historyModal = document.getElementById('mentorHistoryModal');
  if (historyModal) {
    historyModal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeMentorHistoryModal();
      }
    });
  }
  
  updateTeachingDisplay();
  
  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏ß‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏à‡∏≤‡∏Å API
  try {
    await ObservationUtils.loadObservations();
    await ObservationUtils.populateObservationSelector('mentorPeriodSelector', currentMentorPeriodId, { 
      includeEmpty: false, 
      showActiveFirst: true 
    });
    
    // Hide server-side warning banner if active observation exists
    const activePeriod = ObservationUtils.getActiveObservation();
    if (activePeriod) {
      const banner = document.getElementById('noMentorActiveBanner');
      if (banner) banner.style.display = 'none';
    }
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    if (!isPureAdminClient) {
      changeMentorPeriod();
    }
  } catch (err) {
    console.error('Error loading observations:', err);
    const selector = document.getElementById('mentorPeriodSelector');
    if (selector) {
      selector.innerHTML = '<option value="">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</option>';
    }
  }
});
</script>
