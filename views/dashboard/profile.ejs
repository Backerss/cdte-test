<div class="page-content">
  <div class="card">
    <h2 style="margin-top:0;color:var(--color-primary);display:flex;align-items:center;gap:12px">
      <span>üë§</span>
      ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
    </h2>
    <p class="text-muted">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>

    <form id="profileForm" class="dashboard-form" style="margin-top:24px">
      <!-- Profile Picture Section -->
      <div style="text-align:center;margin-bottom:32px">
        <div style="position:relative;display:inline-block">
          <img id="profileImage" 
            src="<%= user.avatar || '/img/default-avatar.svg' %>" 
               alt="Profile" 
               style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:4px solid var(--color-primary)"
            onerror="this.src='/img/default-avatar.svg'">
          <input type="file" id="avatarInput" accept="image/*" style="display:none">
        </div>
        <div style="margin-top:16px">
          <button type="button" class="btn btn--secondary" onclick="document.getElementById('avatarInput').click()" style="font-size:0.9rem">
            ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
          </button>
          <p style="margin:8px 0 0 0;font-size:0.85rem;color:var(--color-muted)">
            ‚ö†Ô∏è ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏≠‡∏∑‡πà‡∏ô (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB)
          </p>
        </div>
      </div>

      <!-- Personal Information Section -->
      <h3 style="color:var(--color-text);margin-bottom:16px;padding-bottom:8px;border-bottom:2px solid var(--color-border)">
        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
      </h3>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
        <div class="form-group">
          <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠ <span style="color:var(--color-danger)">*</span></label>
          <input type="text" id="firstNameInput" class="form-input" value="<%= user.firstName || '' %>" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠" required>
        </div>
        <div class="form-group">
          <label class="form-label">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span style="color:var(--color-danger)">*</span></label>
          <input type="text" id="lastNameInput" class="form-input" value="<%= user.lastName || '' %>" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
        <div class="form-group">
          <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
          <input type="text" class="form-input" value="<%= user.studentId || '' %>" disabled style="background-color:var(--color-bg);cursor:not-allowed">
          <small style="color:var(--color-muted);font-size:0.85rem">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ</small>
        </div>
        <div class="form-group">
          <label class="form-label">‡∏Ñ‡∏ì‡∏∞</label>
          <input type="text" class="form-input" value="‡∏Ñ‡∏ì‡∏∞‡∏Ñ‡∏£‡∏∏‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå" disabled style="background-color:var(--color-bg);cursor:not-allowed">
          <small style="color:var(--color-muted);font-size:0.85rem">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ</small>
        </div>
      </div>

      <div class="form-group" style="margin-bottom:16px">
        <label class="form-label">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤ <span style="color:var(--color-danger)">*</span></label>
        <select id="majorSelect" class="form-input" required style="cursor:pointer">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤ --</option>
          <option value="computer-education" <%= user.major === 'computer-education' ? 'selected' : '' %>>‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
          <option value="digital-technology-education" <%= user.major === 'digital-technology-education' ? 'selected' : '' %>>‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
        </select>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
        <div class="form-group">
          <label class="form-label">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
          <input type="text" id="yearInput" class="form-input" value="<%= user.year || '' %>" disabled style="background-color:var(--color-bg);cursor:not-allowed">
        </div>
        <div class="form-group">
          <label class="form-label">‡∏´‡πâ‡∏≠‡∏á <span style="color:var(--color-danger)">*</span></label>
          <select id="roomSelect" class="form-input" style="cursor:pointer">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
          </select>
          <small id="roomHint" style="color:var(--color-muted);font-size:0.85rem">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</small>
        </div>
      </div>

      <div class="form-group" style="margin-bottom:16px">
        <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏• <span style="color:var(--color-danger)">*</span></label>
        <input type="email" id="emailInput" class="form-input" value="<%= user.email || '' %>" placeholder="email@nsru.ac.th" required>
        <div id="emailWarning" style="display:none;margin-top:8px;padding:12px;background:#fff3cd;border-left:4px solid #ffc107;border-radius:4px">
          <strong style="color:#856404">‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong>
          <span style="color:#856404;font-size:0.9rem">‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ Email ‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Email @nsru.ac.th</span>
        </div>
      </div>

      <div class="form-group" style="margin-bottom:16px">
        <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
        <input type="tel" id="phoneInput" class="form-input" value="<%= user.phone || '' %>" placeholder="0X-XXXX-XXXX" pattern="0[689]\d{8}">
        <small style="color:var(--color-muted);font-size:0.85rem">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: 0X-XXXX-XXXX</small>
      </div>

      <hr style="border:none;border-top:1px solid var(--color-border);margin:32px 0">

      <!-- Change Password Section -->
      <h3 style="color:var(--color-text);margin-bottom:16px;padding-bottom:8px;border-bottom:2px solid var(--color-border)">
        ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
      </h3>

      <div class="form-group" style="margin-bottom:16px">
        <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
        <input type="password" id="currentPasswordInput" class="form-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô">
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
        <div class="form-group">
          <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
          <input type="password" id="newPasswordInput" class="form-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" minlength="8">
          <small style="color:var(--color-muted);font-size:0.85rem">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</small>
        </div>
        <div class="form-group">
          <label class="form-label">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
          <input type="password" id="confirmPasswordInput" class="form-input" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
        </div>
      </div>

      <div style="display:flex;gap:12px;margin-top:24px">
        <button type="submit" class="btn btn--primary">
          üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
        <button type="button" class="btn" style="background-color:var(--color-bg);color:var(--color-text)" onclick="resetForm()">
          ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Image Crop Modal -->
<div id="cropModal" class="modal-overlay" style="display:none">
  <div class="modal-content" style="max-width:600px">
    <div class="modal-header">
      <h3>‡∏Ñ‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
      <button type="button" class="modal-close" onclick="closeCropModal()">√ó</button>
    </div>
    <div class="modal-body" style="padding:24px">
      <p style="margin:0 0 16px 0;color:var(--color-muted)">
        ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)
      </p>
      <div style="max-height:400px;overflow:hidden;background:#000;border-radius:8px">
        <img id="cropImage" style="max-width:100%;display:block">
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn--secondary" onclick="closeCropModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button type="button" class="btn btn--primary" onclick="applyCrop()">‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ</button>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  animation: fadeIn 0.2s ease;
}

.modal-content {
  background: var(--color-surface);
  border-radius: 12px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
  animation: slideUp 0.3s ease;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 2px solid var(--color-border);
}

.modal-header h3 {
  margin: 0;
  color: var(--color-primary);
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.8rem;
  cursor: pointer;
  color: var(--color-muted);
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s ease;
  line-height: 1;
}

.modal-close:hover {
  color: var(--color-danger);
  background: rgba(0, 0, 0, 0.05);
}

.modal-body {
  padding: 24px;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 20px 24px;
  border-top: 2px solid var(--color-border);
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>

<script>
let cropper = null;
let croppedImageBlob = null;

// Email validation
document.getElementById('emailInput').addEventListener('blur', function() {
  const email = this.value.trim();
  const warning = document.getElementById('emailWarning');
  
  if (email && !email.endsWith('@nsru.ac.th')) {
    warning.style.display = 'block';
  } else {
    warning.style.display = 'none';
  }
});

// Avatar upload with size check
document.getElementById('avatarInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;

  // Check file size (10MB = 10 * 1024 * 1024 bytes)
  const maxSize = 10 * 1024 * 1024;
  if (file.size > maxSize) {
    Swal.fire({
      icon: 'error',
      title: '‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ',
      text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10MB',
      confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö'
    });
    e.target.value = '';
    return;
  }

  // Check if it's an image
  if (!file.type.startsWith('image/')) {
    Swal.fire({
      icon: 'error',
      title: '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
      text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
      confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö'
    });
    e.target.value = '';
    return;
  }

  // Load image for cropping
  const reader = new FileReader();
  reader.onload = function(event) {
    document.getElementById('cropImage').src = event.target.result;
    openCropModal();
  };
  reader.readAsDataURL(file);
});

function openCropModal() {
  document.getElementById('cropModal').style.display = 'flex';
  
  // Initialize cropper
  const image = document.getElementById('cropImage');
  if (cropper) {
    cropper.destroy();
  }
  
  cropper = new Cropper(image, {
    aspectRatio: 1,
    viewMode: 1,
    dragMode: 'move',
    autoCropArea: 0.8,
    restore: false,
    guides: true,
    center: true,
    highlight: false,
    cropBoxMovable: true,
    cropBoxResizable: true,
    toggleDragModeOnDblclick: false,
  });
}

function closeCropModal() {
  document.getElementById('cropModal').style.display = 'none';
  if (cropper) {
    cropper.destroy();
    cropper = null;
  }
  document.getElementById('avatarInput').value = '';
}

function applyCrop() {
  if (!cropper) return;

  cropper.getCroppedCanvas({
    width: 300,
    height: 300,
    imageSmoothingEnabled: true,
    imageSmoothingQuality: 'high',
  }).toBlob(function(blob) {
    croppedImageBlob = blob;
    const url = URL.createObjectURL(blob);
    document.getElementById('profileImage').src = url;
    closeCropModal();
    
    Swal.fire({
      icon: 'success',
      title: '‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á',
      timer: 2000,
      showConfirmButton: false
    });
  }, 'image/jpeg', 0.9);
}

// (Submission handled by newer listener below)

function resetForm() {
  if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
    document.getElementById('profileForm').reset();
    document.getElementById('emailWarning').style.display = 'none';
    location.reload();
  }
}

// Close modal when clicking outside
document.getElementById('cropModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeCropModal();
  }
});
</script>
<script>
// Load profile data from server and populate form
async function loadProfile() {
  try {
    const res = await fetch('/api/profile');
    const data = await res.json();
    if (!data.success) throw new Error(data.message || 'Failed to load');

    const user = data.data || {};

    // Populate fields
    document.getElementById('firstNameInput').value = user.firstName || '';
    document.getElementById('lastNameInput').value = user.lastName || '';
    document.getElementById('phoneInput').value = user.phone || '';
    document.getElementById('profileImage').src = user.avatar || '/img/default-avatar.svg';
    document.getElementById('majorSelect').value = user.major || '';

    // Year (computed by server) and room
    const yearInput = document.getElementById('yearInput');
    const roomSelect = document.getElementById('roomSelect');
    const roomHint = document.getElementById('roomHint');
    if (yearInput) yearInput.value = user.year || '';
    if (roomSelect) {
      if (user.room) {
        roomSelect.value = user.room;
      } else {
        roomSelect.value = '';
      }
    }

    const emailInput = document.getElementById('emailInput');
    const emailWarning = document.getElementById('emailWarning');

    if (user.email && user.email.trim() !== '') {
      // Email already set ‚Äî disable editing
      emailInput.value = user.email;
      emailInput.disabled = true;
      emailWarning.style.display = 'block';
      emailWarning.querySelector('strong').textContent = 'üîí ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß:';
      emailWarning.querySelector('span').textContent = ' ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
    } else {
      emailInput.value = '';
      emailInput.disabled = false;
      // reset the warning text if user types an external email
      emailWarning.querySelector('strong').textContent = '‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:';
      emailWarning.querySelector('span').textContent = ' ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠ Email ‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Email @nsru.ac.th';
      emailWarning.style.display = 'none';
    }

    // Room locking: if server tells roomLocked, disable select
    if (user.roomLocked) {
      if (roomSelect) roomSelect.disabled = true;
      if (roomHint) roomHint.textContent = '‡∏´‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)';
    } else {
      if (roomSelect) roomSelect.disabled = false;
      if (roomHint) roomHint.textContent = '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß';
    }

  } catch (err) {
    console.error('Load profile error', err);
  }
}

loadProfile();

// Upload avatar helper - returns avatarUrl
async function uploadAvatarIfNeeded() {
  if (!croppedImageBlob) return null;

  const fd = new FormData();
  fd.append('avatar', croppedImageBlob, 'avatar.jpg');

  const resp = await fetch('/api/profile/avatar', { method: 'POST', body: fd });
  const json = await resp.json();
  if (!json.success) {
    throw new Error(json.message || 'Upload failed');
  }
  return json.avatarUrl;
}

// Submit profile
document.getElementById('profileForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const firstName = document.getElementById('firstNameInput').value.trim();
  const lastName = document.getElementById('lastNameInput').value.trim();
  const major = document.getElementById('majorSelect').value;
  const emailInput = document.getElementById('emailInput');
  const email = emailInput.value.trim();
  const phone = document.getElementById('phoneInput').value.trim();
  const currentPassword = document.getElementById('currentPasswordInput').value;
  const newPassword = document.getElementById('newPasswordInput').value;
  const confirmPassword = document.getElementById('confirmPasswordInput').value;

  if (!firstName || !lastName || !major) {
    Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö' });
    return;
  }

  // If email input is enabled, validate basic format
  if (!emailInput.disabled) {
    if (!email || !email.includes('@')) {
      Swal.fire({ icon: 'warning', title: '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö' });
      return;
    }
  }

  // Handle password change first (if requested)
  if (newPassword || confirmPassword) {
    if (!currentPassword) {
      Swal.fire({ icon: 'warning', title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô', confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö' });
      return;
    }
    if (newPassword !== confirmPassword) {
      Swal.fire({ icon: 'error', title: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô', confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö' });
      return;
    }
    if (newPassword.length < 8) {
      Swal.fire({ icon: 'warning', title: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', text: '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö' });
      return;
    }

    // Call change-password endpoint
    const pwResp = await fetch('/api/profile/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ currentPassword, newPassword })
    });
    const pwJson = await pwResp.json();
    if (!pwJson.success) {
      Swal.fire({ icon: 'error', title: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: pwJson.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö' });
      return;
    }
  }

  try {
    Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

    // Upload avatar if there's a new cropped image
    let avatarUrl = null;
    if (croppedImageBlob) {
      avatarUrl = await uploadAvatarIfNeeded();
    }

    // Prepare payload
    const payload = { firstName, lastName, major, email, phone };
    const roomSelect = document.getElementById('roomSelect');
    if (roomSelect) {
      const roomVal = roomSelect.value;
      if (roomVal) payload.room = roomVal;
    }
    if (avatarUrl) payload.avatar = avatarUrl;

    const res = await fetch('/api/profile', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const json = await res.json();
    Swal.close();
    if (json.success) {
      Swal.fire({ icon: 'success', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' }).then(() => {
        // Clear password fields
        document.getElementById('currentPasswordInput').value = '';
        document.getElementById('newPasswordInput').value = '';
        document.getElementById('confirmPasswordInput').value = '';
        croppedImageBlob = null;
        loadProfile();
      });
    } else {
      Swal.fire({ icon: 'error', title: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', text: json.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö' });
    }

  } catch (err) {
    console.error(err);
    Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', text: err.message || '', confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö' });
  }
});

// Disable email editing if it's already set - handled in loadProfile

</script>
