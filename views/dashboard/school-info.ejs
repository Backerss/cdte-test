<div class="page-content">
  <div class="card">
    <h2 style="margin-top:0;color:var(--color-primary);display:flex;align-items:center;gap:12px">
      <span>üè´</span>
      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤
    </h2>
    <p class="text-muted">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ù‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û</p>

    <form class="dashboard-form" style="margin-top:24px">
      <!-- Basic School Information -->
      <div class="form-section">
        <h3 class="form-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h3>
        
        <div class="form-group">
          <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤ <span class="required">*</span></label>
          <input type="text" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏î‡πÑ‡∏ú‡πà‡∏•‡πâ‡∏≠‡∏°" required>
        </div>

        <div class="form-group">
          <label class="form-label">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î <span class="required">*</span></label>
          <select id="affiliationSelect" class="form-input" required onchange="onAffiliationChange()">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</option>
            <option value="‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (‡∏™‡∏û‡∏ê.)</option>
            <option value="‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (‡∏™‡∏û‡∏°.)</option>
            <option value="‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô (‡∏≠‡∏õ‡∏ó.)</option>
            <option value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£">‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£ (BMA)</option>
            <option value="‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢">‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</option>
            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
          </select>
        </div>
      </div>

      <!-- Address Information -->
      <div class="form-section">
        <h3 class="form-section-title">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</h3>
        
        <div class="form-group">
          <label class="form-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‡∏ñ‡∏ô‡∏ô ‡∏ï‡∏£‡∏≠‡∏Å ‡∏ã‡∏≠‡∏¢</label>
          <input type="text" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô 123 ‡∏ñ‡∏ô‡∏ô‡∏û‡∏´‡∏•‡πÇ‡∏¢‡∏ò‡∏¥‡∏ô ‡∏ã‡∏≠‡∏¢ 5">
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="form-group">
            <label class="form-label">‡πÄ‡∏Ç‡∏ï/‡πÅ‡∏Ç‡∏ß‡∏á</label>
            <input type="text" id="districtAreaInput" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ç‡∏ï‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏ï‡∏≥‡∏ö‡∏•</label>
            <input type="text" id="subdistrictInput" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏≥‡∏ö‡∏•‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á" autocomplete="off">
            <div id="subdistrictSuggestions" class="suggestion-box" style="display:none;position:relative;z-index:1200"></div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
          <div class="form-group">
            <label class="form-label">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ <span class="required">*</span></label>
            <input type="text" id="amphoeInput" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå" autocomplete="off" required>
            <div id="amphoeSuggestions" class="suggestion-box" style="display:none;position:relative;z-index:1200"></div>
          </div>
          <div class="form-group">
            <label class="form-label">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î <span class="required">*</span></label>
            <input type="text" id="provinceInput" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå" autocomplete="off" required>
            <div id="provinceSuggestions" class="suggestion-box" style="display:none;position:relative;z-index:1200"></div>
          </div>
          <div class="form-group">
            <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå <span class="required">*</span></label>
            <input type="text" id="postcodeInput" class="form-input" placeholder="60000" pattern="[0-9]{5}" maxlength="5" required readonly>
          </div>
        </div>
      </div>

      <!-- Grade Levels -->
      <div class="form-section">
        <h3 class="form-section-title">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h3>
        
        <div class="form-group">
          <label class="form-label">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≠‡∏ô <span class="required">*</span></label>
          <div class="grade-level-input">
            <input type="text" 
                   id="gradeLevelsDisplay" 
                   class="form-input" 
                   placeholder="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô" 
                   readonly 
                   style="cursor:pointer">
            <button type="button" 
                    class="grade-level-btn" 
                    onclick="openGradeLevelModal()"
                    style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--color-primary);cursor:pointer;font-size:1.2rem">
              ‚öôÔ∏è
            </button>
          </div>
          <div id="gradeLevelTags" class="grade-tags" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px"></div>
        </div>
      </div>

      <!-- School Statistics -->
      <div class="form-section">
        <h3 class="form-section-title">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
        
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
          <div class="form-group">
            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
            <input type="number" class="form-input" placeholder="0" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏π</label>
            <input type="number" class="form-input" placeholder="0" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</label>
            <input type="number" class="form-input" placeholder="0" min="0">
          </div>
        </div>
      </div>

      <!-- Contact Information -->
      <div class="form-section">
        <h3 class="form-section-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h3>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="form-group">
            <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
            <input type="tel" class="form-input" placeholder="056-123456">
          </div>
          <div class="form-group">
            <label class="form-label">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
            <input type="email" class="form-input" placeholder="school@example.com">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
          <input type="text" class="form-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ">
        </div>
      </div>

      <div class="form-actions" style="margin-top:32px;display:flex;gap:12px">
        <button type="submit" class="btn btn--primary">
          üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
        <button type="reset" class="btn btn--secondary">
          üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Grade Level Selection Modal -->
<div id="gradeLevelModal" class="modal-overlay" style="display:none">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô</h3>
      <button type="button" class="modal-close" onclick="closeGradeLevelModal()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="grade-selection">
        <div class="grade-category kindergarten">
          <h4>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•</h4>
          <div class="checkbox-grid">
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏≠.1" onchange="updateGradeLevels()">
              <span>‡∏≠.1</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏≠.2" onchange="updateGradeLevels()">
              <span>‡∏≠.2</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏≠.3" onchange="updateGradeLevels()">
              <span>‡∏≠.3</span>
            </label>
          </div>
        </div>
        <div class="grade-category primary">
          <h4>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h4>
          <div class="checkbox-grid">
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏õ.1" onchange="updateGradeLevels()">
              <span>‡∏õ.1</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏õ.2" onchange="updateGradeLevels()">
              <span>‡∏õ.2</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏õ.3" onchange="updateGradeLevels()">
              <span>‡∏õ.3</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏õ.4" onchange="updateGradeLevels()">
              <span>‡∏õ.4</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏õ.5" onchange="updateGradeLevels()">
              <span>‡∏õ.5</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏õ.6" onchange="updateGradeLevels()">
              <span>‡∏õ.6</span>
            </label>
          </div>
        </div>

        <div class="grade-category lower-secondary">
          <h4>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏ï‡πâ‡∏ô</h4>
          <div class="checkbox-grid">
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏°.1" onchange="updateGradeLevels()">
              <span>‡∏°.1</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏°.2" onchange="updateGradeLevels()">
              <span>‡∏°.2</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏°.3" onchange="updateGradeLevels()">
              <span>‡∏°.3</span>
            </label>
          </div>
        </div>

        <div class="grade-category upper-secondary">
          <h4>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ï‡∏≠‡∏ô‡∏õ‡∏•‡∏≤‡∏¢</h4>
          <div class="checkbox-grid">
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏°.4" onchange="updateGradeLevels()">
              <span>‡∏°.4</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏°.5" onchange="updateGradeLevels()">
              <span>‡∏°.5</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="‡∏°.6" onchange="updateGradeLevels()">
              <span>‡∏°.6</span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn--secondary" onclick="clearAllGrades()">
        ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      </button>
      <button type="button" class="btn btn--primary" onclick="closeGradeLevelModal()">
        ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
      </button>
    </div>
  </div>
</div>

<style>
.form-section {
  margin-bottom: 32px;
  padding-bottom: 24px;
  border-bottom: 1px solid var(--color-border);
}

.form-section:last-of-type {
  border-bottom: none;
  margin-bottom: 0;
}

.form-section-title {
  color: var(--color-primary);
  font-size: 1.2rem;
  font-weight: 600;
  margin: 0 0 20px 0;
  display: flex;
  align-items: center;
  gap: 8px;
}

.form-section-title::before {
  content: '';
  width: 4px;
  height: 20px;
  background: var(--color-primary);
  border-radius: 2px;
}

.required {
  color: var(--color-danger);
  font-weight: 600;
}

.grade-level-input {
  position: relative;
}

.grade-level-btn {
  transition: color 0.2s ease;
}

.grade-level-btn:hover {
  color: var(--color-secondary) !important;
}

.grade-tags {
  min-height: 20px;
}

.grade-tag {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: var(--color-primary);
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 500;
}

.grade-tag-remove {
  background: none;
  border: none;
  color: white;
  cursor: pointer;
  font-size: 0.9rem;
  padding: 0;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s ease;
}

.grade-tag-remove:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* Modal Styles */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: var(--color-surface);
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid var(--color-border);
}

.modal-header h3 {
  margin: 0;
  color: var(--color-text);
  font-size: 1.25rem;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--color-muted);
  padding: 4px;
  border-radius: 4px;
  transition: color 0.2s ease;
}

.modal-close:hover {
  color: var(--color-danger);
}

.modal-body {
  padding: 24px;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 20px 24px;
  border-top: 1px solid var(--color-border);
}

.grade-category {
  margin-bottom: 24px;
}

.grade-category h4 {
  color: var(--color-text);
  font-size: 1rem;
  font-weight: 600;
  margin: 0 0 12px 0;
}

.checkbox-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
  gap: 8px;
}

.checkbox-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 12px;
  border: 1px solid var(--color-border);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

.checkbox-item:hover {
  border-color: var(--color-primary);
  background: var(--color-bg);
}

.checkbox-item input[type="checkbox"] {
  margin: 0;
}

.checkbox-item input[type="checkbox"]:checked + span {
  color: var(--color-primary);
  font-weight: 600;
}

.btn--secondary {
  background: var(--color-muted);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: background 0.2s ease;
}

.btn--secondary:hover {
  background: var(--color-text);
}
</style>

<script>
let selectedGrades = [];

function openGradeLevelModal() {
  document.getElementById('gradeLevelModal').style.display = 'flex';
}

function closeGradeLevelModal() {
  document.getElementById('gradeLevelModal').style.display = 'none';
}

function onAffiliationChange() {
  const sel = document.getElementById('affiliationSelect');
  if (!sel) return;
  const val = sel.value || '';

  const kindergartenBlock = document.querySelector('.grade-category.kindergarten');
  const primaryBlock = document.querySelector('.grade-category.primary');
  const lowerBlock = document.querySelector('.grade-category.lower-secondary');
  const upperBlock = document.querySelector('.grade-category.upper-secondary');

  const isSpm = val.includes('‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏ï‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏°‡∏±‡∏ò‡∏¢‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤');

  if (isSpm) {
    // Only show ‡∏°.1-‡∏°.6 (both lower- and upper-secondary should be visible)
    if (kindergartenBlock) kindergartenBlock.style.display = 'none';
    if (primaryBlock) primaryBlock.style.display = 'none';
    if (lowerBlock) lowerBlock.style.display = 'block';
    if (upperBlock) upperBlock.style.display = 'block';

    // Uncheck hidden checkboxes (kindergarten + primary only)
    document.querySelectorAll('.grade-category.kindergarten input, .grade-category.primary input')
      .forEach(cb => { cb.checked = false; cb.dispatchEvent(new Event('change')); });
  } else {
    // show all
    if (kindergartenBlock) kindergartenBlock.style.display = 'block';
    if (primaryBlock) primaryBlock.style.display = 'block';
    if (lowerBlock) lowerBlock.style.display = 'block';
    if (upperBlock) upperBlock.style.display = 'block';
  }
}

function updateGradeLevels() {
  const checkboxes = document.querySelectorAll('#gradeLevelModal input[type="checkbox"]');
  selectedGrades = [];
  
  checkboxes.forEach(checkbox => {
    if (checkbox.checked) {
      selectedGrades.push(checkbox.value);
    }
  });
  
  // Sort grades properly: ‡∏≠. (kindergarten) -> ‡∏õ. (primary) -> ‡∏°. (secondary), then by number
  selectedGrades.sort((a, b) => {
    const order = ch => {
      if (ch === '‡∏≠') return 0;
      if (ch === '‡∏õ') return 1;
      if (ch === '‡∏°') return 2;
      return 3;
    };
    const aChar = a.charAt(0);
    const bChar = b.charAt(0);
    const aOrder = order(aChar);
    const bOrder = order(bChar);
    if (aOrder !== bOrder) return aOrder - bOrder;

    const aNum = parseInt(a.replace(/[^0-9]/g, '')) || 0;
    const bNum = parseInt(b.replace(/[^0-9]/g, '')) || 0;
    return aNum - bNum;
  });
  
  updateGradeDisplay();
}

function updateGradeDisplay() {
  const display = document.getElementById('gradeLevelsDisplay');
  const tagsContainer = document.getElementById('gradeLevelTags');
  
  // Update input display
  display.value = selectedGrades.length > 0 
    ? `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ${selectedGrades.length} ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô` 
    : '';
  
  // Update tags
  tagsContainer.innerHTML = '';
  selectedGrades.forEach(grade => {
    const tag = document.createElement('span');
    tag.className = 'grade-tag';
    tag.innerHTML = `
      ${grade}
      <button type="button" class="grade-tag-remove" onclick="removeGrade('${grade}')">√ó</button>
    `;
    tagsContainer.appendChild(tag);
  });
}

function removeGrade(grade) {
  selectedGrades = selectedGrades.filter(g => g !== grade);
  
  // Uncheck the corresponding checkbox
  const checkbox = document.querySelector(`#gradeLevelModal input[value="${grade}"]`);
  if (checkbox) checkbox.checked = false;
  
  updateGradeDisplay();
}

function clearAllGrades() {
  selectedGrades = [];
  const checkboxes = document.querySelectorAll('#gradeLevelModal input[type="checkbox"]');
  checkboxes.forEach(checkbox => checkbox.checked = false);
  updateGradeDisplay();
}

// Close modal when clicking outside
document.getElementById('gradeLevelModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeGradeLevelModal();
  }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  updateGradeDisplay();
  // Ensure grade options reflect current affiliation on load
  onAffiliationChange();
  // Load Thai address dataset and bind autocomplete
  loadThaiAddressData();
});

// --- Address autocomplete using kongvut single API ---
const KONGVUT_SUBDIST_URL = 'https://raw.githubusercontent.com/kongvut/thai-province-data/refs/heads/master/api/latest/sub_district_with_district_and_province.json';
let _subdistricts = [];
let _districts = [];
let _provinces = [];

async function loadThaiAddressData() {
  try {
    const res = await fetch(KONGVUT_SUBDIST_URL);
    if (!res.ok) throw new Error('Failed to fetch address data');
    const data = await res.json();

    // Normalize and build unique lists
    _subdistricts = data.map(sd => ({
      id: sd.id,
      name: sd.name_th,
      zip: sd.zip_code,
      district_id: sd.district_id,
      district_name: sd.district && sd.district.name_th ? sd.district.name_th : (sd.district_name || ''),
      province_id: (sd.province && sd.province.id) || (sd.district && sd.district.province_id) || null,
      province_name: sd.province && sd.province.name_th ? sd.province.name_th : (sd.district && sd.district.province && sd.district.province.name_th) || ''
    }));

    const districtMap = new Map();
    const provinceMap = new Map();

    _subdistricts.forEach(sd => {
      if (sd.district_id && !districtMap.has(sd.district_id)) {
        districtMap.set(sd.district_id, { id: sd.district_id, name: sd.district_name, province_id: sd.province_id });
      }
      if (sd.province_id && sd.province_name && !provinceMap.has(sd.province_id)) {
        provinceMap.set(sd.province_id, { id: sd.province_id, name: sd.province_name });
      }
    });

    _districts = Array.from(districtMap.values());
    _provinces = Array.from(provinceMap.values());

    bindAddressAutocomplete();
  } catch (err) {
    console.error('Address data load failed', err);
  }
}

function showSuggestions(listEl, items, onSelect) {
  if (!listEl) return;
  listEl.innerHTML = '';
  if (!items || items.length === 0) { listEl.style.display = 'none'; return; }

  items.slice(0, 8).forEach(it => {
    const div = document.createElement('div');
    div.className = 'suggestion-item';
    div.style.padding = '6px 10px';
    div.style.cursor = 'pointer';
    div.style.borderBottom = '1px solid rgba(0,0,0,0.04)';
    div.textContent = it.name;
    div.addEventListener('mousedown', function(e) {
      e.preventDefault();
      onSelect(it);
    });
    listEl.appendChild(div);
  });

  listEl.style.display = 'block';
}

function bindAddressAutocomplete() {
  const subEl = document.getElementById('subdistrictInput');
  const subList = document.getElementById('subdistrictSuggestions');
  const amphoeEl = document.getElementById('amphoeInput');
  const amphoeList = document.getElementById('amphoeSuggestions');
  const provEl = document.getElementById('provinceInput');
  const provList = document.getElementById('provinceSuggestions');
  const postcodeEl = document.getElementById('postcodeInput');

  if (subEl) {
    subEl.addEventListener('input', function() {
      const q = this.value.trim();
      if (!q) { showSuggestions(subList, []); return; }
      const results = _subdistricts.filter(s => s.name.includes(q) || s.name.startsWith(q));
      showSuggestions(subList, results, sel => {
        subEl.value = sel.name;
        if (amphoeEl) amphoeEl.value = sel.district_name || '';
        if (provEl) provEl.value = sel.province_name || '';
        if (postcodeEl) postcodeEl.value = sel.zip || '';
        showSuggestions(subList, []);
      });
    });
    document.addEventListener('click', (e) => { if (e.target !== subEl) subList.style.display = 'none'; });
  }

  if (amphoeEl) {
    amphoeEl.addEventListener('input', function() {
      const q = this.value.trim();
      if (!q) { showSuggestions(amphoeList, []); return; }
      const results = _districts.filter(d => d.name && d.name.includes(q));
      showSuggestions(amphoeList, results, sel => {
        amphoeEl.value = sel.name || '';
        // set province if known
        const prov = _provinces.find(p => p.id === sel.province_id);
        if (provEl && prov) provEl.value = prov.name;
        // clear postcode because amphoe has many zip codes
        if (postcodeEl) postcodeEl.value = '';
        showSuggestions(amphoeList, []);
      });
    });
    document.addEventListener('click', (e) => { if (e.target !== amphoeEl) amphoeList.style.display = 'none'; });
  }

  if (provEl) {
    provEl.addEventListener('input', function() {
      const q = this.value.trim();
      if (!q) { showSuggestions(provList, []); return; }
      const results = _provinces.filter(p => p.name && p.name.includes(q));
      showSuggestions(provList, results, sel => {
        provEl.value = sel.name || '';
        showSuggestions(provList, []);
      });
    });
    document.addEventListener('click', (e) => { if (e.target !== provEl) provList.style.display = 'none'; });
  }
}

// small CSS for suggestion items (inserted via JS in case external CSS not ready)
(() => {
  const css = `
    .suggestion-box{background:var(--color-surface);border:1px solid rgba(0,0,0,0.06);border-radius:6px;position:absolute;left:0;right:0;box-shadow:0 6px 18px rgba(0,0,0,0.08);max-height:220px;overflow:auto}
    .suggestion-item{padding:6px 10px}
    .suggestion-item:hover{background:var(--color-bg);}
  `;
  const s = document.createElement('style'); s.appendChild(document.createTextNode(css)); document.head.appendChild(s);
})();
</script>