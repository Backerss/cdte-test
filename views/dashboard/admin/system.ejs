<div class="page-content">
  <div class="card">
    <div class="page-header">
      <div>
        <h2 style="margin-top:0;color:var(--color-primary);display:flex;align-items:center;gap:12px">
          <span>‚öôÔ∏è</span>
          ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö
        </h2>
        <p class="text-muted">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå ‡∏î‡∏π Logs ‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô</p>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn--secondary" onclick="refreshSystemData()">
          <span>üîÑ</span> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
        </button>
        <button class="btn btn--primary" onclick="openBackupModal()">
          <span>üíæ</span> ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
        <button class="btn btn--danger" onclick="openResetDatabaseModal()" style="background: var(--color-danger); color: white;">
          <span>üóëÔ∏è</span> Reset Database
        </button>
      </div>
    </div>

    <!-- System Status Control -->
    <div class="system-section">
      <h3 class="section-title">
        <span>üåê</span> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå
      </h3>

      <div class="status-control-grid">
        <div class="status-card active" id="statusOnline" onclick="setSystemStatus('online')">
          <div class="status-icon">‚úÖ</div>
          <div class="status-label">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div>
          <div class="status-desc">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥</div>
        </div>

        <div class="status-card" id="statusMaintenance" onclick="setSystemStatus('maintenance')">
          <div class="status-icon">üîß</div>
          <div class="status-label">‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤</div>
          <div class="status-desc">‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</div>
        </div>

        <div class="status-card" id="statusOffline" onclick="setSystemStatus('offline')">
          <div class="status-icon">üö´</div>
          <div class="status-label">‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</div>
          <div class="status-desc">‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        </div>
      </div>

      <div class="status-message" id="statusMessage">
        <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> <span id="currentStatus">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</span>
        <span style="margin-left:16px;color:var(--color-muted)">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdate">-</span></span>
      </div>
    </div>

    <!-- System Logs Viewer -->
    <div class="system-section">
      <h3 class="section-title">
        <span>üìù</span> System Logs
      </h3>

      <div class="logs-controls">
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
          <select id="logLevel" class="form-input" style="width:auto;min-width:120px;" onchange="filterLogs()">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
            <option value="info">Info</option>
            <option value="warning">Warning</option>
            <option value="error">Error</option>
            <option value="debug">Debug</option>
          </select>

          <select id="logCategory" class="form-input" style="width:auto;min-width:150px;" onchange="filterLogs()">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
            <option value="auth">Authentication</option>
            <option value="database">Database</option>
            <option value="api">API</option>
            <option value="system">System</option>
          </select>

          <input type="text" id="logSearch" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ logs..."
            style="flex:1;min-width:200px;" onkeyup="filterLogs()">

          <button class="btn btn--secondary" onclick="clearLogsDisplay()">
            <span>üóëÔ∏è</span> ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
          </button>

          <button class="btn btn--primary" onclick="exportLogs()">
            <span>üì•</span> Export
          </button>
        </div>

        <div class="logs-auto-refresh">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()" checked>
            <span>Auto-refresh (5s)</span>
          </label>
        </div>
      </div>

      <div class="logs-viewer" id="logsViewer">
        <div class="log-entry" style="text-align:center;padding:40px;color:var(--color-muted);">
          ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î logs...
        </div>
      </div>
    </div>

    <!-- Recent Activities -->
    <div class="system-section">
      <h3 class="section-title">
        <span>üïê</span> ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)
      </h3>
      <p style="color: var(--color-muted); margin: 0 0 16px 0; font-size: 0.9rem;">üìù ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>

      <div class="activity-list" id="activityList">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- Backup Modal -->
<div id="backupModal" class="modal-overlay" style="display:none">
  <div class="modal-content" style="max-width:600px;">
    <div class="modal-header">
      <h3>üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h3>
      <button type="button" class="modal-close" onclick="closeBackupModal()">√ó</button>
    </div>

    <div class="modal-body" style="padding:24px;">
      <div class="form-group">
        <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á</label>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="backupDB" checked>
            <span>üóÑÔ∏è ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="backupFiles" checked>
            <span>üìÅ ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î</span>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="backupConfig" checked>
            <span>‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span>
          </label>
        </div>
      </div>

      <div class="backup-info" style="background:var(--color-bg);padding:16px;border-radius:8px;margin-top:16px;">
        <div style="font-size:0.9rem;color:var(--color-muted);margin-bottom:8px;">üì¶ Backup ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <div style="font-weight:500;" id="lastBackupDate">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn--secondary" onclick="closeBackupModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button type="button" class="btn btn--primary" onclick="performBackup()">
        <span>üíæ</span> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      </button>
    </div>
  </div>
</div>

<!-- Reset Database Modal -->
<div id="resetDatabaseModal" class="modal-overlay" style="display:none">
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header" style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white;">
      <h3 style="color: white;">‚ö†Ô∏è Reset ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
      <button type="button" class="modal-close" onclick="closeResetDatabaseModal()" style="color: white;">√ó</button>
    </div>

    <div class="modal-body" style="padding:24px;">
      <div class="danger-warning" style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <span style="font-size: 2rem;">üö®</span>
          <strong style="color: #dc2626; font-size: 1.1rem;">‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</strong>
        </div>
        <ul style="margin: 0; padding-left: 20px; color: #7f1d1d;">
          <li>‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</li>
          <li>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß</li>
          <li>‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Admin ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (admin/admin123)</li>
          <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ, ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô, ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
        </ul>
      </div>

      <div class="verification-section">
        <label class="form-label" style="font-weight: 600; color: #dc2626;">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á:</label>
        <div id="verificationCode" style="background: #f3f4f6; padding: 12px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 1.2rem; font-weight: bold; text-align: center; letter-spacing: 4px; margin: 12px 0; color: #1f2937; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;"></div>
        <input type="text" id="verificationInput" class="form-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô 16 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£" maxlength="16" autocomplete="off" style="font-family: 'Courier New', monospace; letter-spacing: 2px; text-align: center; font-size: 1.1rem;">
        <small style="color: #6b7280; display: block; margin-top: 8px;">‚ö†Ô∏è ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Copy-Paste ‡πÑ‡∏î‡πâ</small>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn--secondary" onclick="closeResetDatabaseModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button type="button" class="btn btn--danger" onclick="verifyResetDatabase()" style="background: var(--color-danger); color: white;">
        <span>üóëÔ∏è</span> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Reset
      </button>
    </div>
  </div>
</div>

<style>
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 32px;
    gap: 16px;
    flex-wrap: wrap;
  }

  .system-section {
    margin-bottom: 32px;
    padding-bottom: 32px;
    border-bottom: 2px solid var(--color-border);
  }

  .system-section:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }

  .section-title {
    color: var(--color-primary);
    font-size: 1.2rem;
    margin: 0 0 20px 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* Status Control */
  .status-control-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  .status-card {
    background: var(--color-surface);
    border: 2px solid var(--color-border);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .status-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .status-card.active {
    border-color: var(--color-primary);
    background: linear-gradient(135deg, rgba(74, 144, 226, 0.05), rgba(74, 144, 226, 0.1));
    box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);
  }

  .status-icon {
    font-size: 2.5rem;
    margin-bottom: 12px;
  }

  .status-label {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--color-text);
    margin-bottom: 6px;
  }

  .status-desc {
    font-size: 0.85rem;
    color: var(--color-muted);
  }

  .status-message {
    background: var(--color-bg);
    padding: 16px;
    border-radius: 8px;
    border-left: 4px solid var(--color-primary);
  }

  /* Health Monitoring */
  .health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
  }

  .health-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    gap: 16px;
    align-items: center;
  }

  .health-icon {
    font-size: 2.5rem;
    flex-shrink: 0;
  }

  .health-info {
    flex: 1;
    min-width: 0;
  }

  .health-label {
    font-size: 0.85rem;
    color: var(--color-muted);
    margin-bottom: 6px;
  }

  .health-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 8px;
  }

  .health-bar {
    height: 8px;
    background: var(--color-bg);
    border-radius: 4px;
    overflow: hidden;
  }

  .health-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    border-radius: 4px;
    transition: width 0.5s ease;
  }

  .health-bar-fill.warning {
    background: linear-gradient(90deg, #FF9800, #FFC107);
  }

  .health-bar-fill.danger {
    background: linear-gradient(90deg, #F44336, #E91E63);
  }

  /* Quick Actions */
  .quick-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 12px;
  }

  .action-btn {
    background: var(--color-surface);
    border: 2px solid var(--color-border);
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
  }

  .action-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-bg);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .action-icon {
    font-size: 2rem;
    margin-bottom: 8px;
  }

  .action-label {
    font-weight: 500;
    color: var(--color-text);
    font-size: 0.9rem;
  }

  /* Logs Viewer */
  .logs-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    gap: 16px;
    flex-wrap: wrap;
  }

  .logs-auto-refresh label {
    font-size: 0.9rem;
    color: var(--color-text);
  }

  .logs-viewer {
    background: #1e1e1e;
    color: #d4d4d4;
    border-radius: 8px;
    padding: 16px;
    max-height: 500px;
    overflow-y: auto;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 0.85rem;
    line-height: 1.6;
  }

  .log-entry {
    padding: 8px 12px;
    border-radius: 4px;
    margin-bottom: 4px;
    border-left: 3px solid transparent;
    transition: background 0.2s ease;
  }

  .log-entry:hover {
    background: rgba(255, 255, 255, 0.05);
  }

  .log-entry.info {
    border-left-color: #4A90E2;
  }

  .log-entry.warning {
    border-left-color: #FFA726;
    background: rgba(255, 167, 38, 0.05);
  }

  .log-entry.error {
    border-left-color: #EF5350;
    background: rgba(239, 83, 80, 0.05);
  }

  .log-entry.debug {
    border-left-color: #9E9E9E;
    opacity: 0.7;
  }

  .log-timestamp {
    color: #858585;
    margin-right: 8px;
  }

  .log-level {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 8px;
    text-transform: uppercase;
  }

  .log-level.info {
    background: #4A90E2;
    color: white;
  }

  .log-level.warning {
    background: #FFA726;
    color: white;
  }

  .log-level.error {
    background: #EF5350;
    color: white;
  }

  .log-level.debug {
    background: #9E9E9E;
    color: white;
  }

  .log-category {
    color: #569CD6;
    margin-right: 8px;
  }

  .log-message {
    color: #d4d4d4;
  }

  /* Activity List */
  .activity-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .activity-item {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    padding: 16px;
    display: flex;
    align-items: start;
    gap: 16px;
  }

  .activity-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .activity-content {
    flex: 1;
    min-width: 0;
  }

  .activity-title {
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 4px;
  }

  .activity-desc {
    font-size: 0.9rem;
    color: var(--color-muted);
    margin-bottom: 6px;
  }

  .activity-time {
    font-size: 0.8rem;
    color: var(--color-muted);
  }

  .status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 500;
  }

  .status-badge.active {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .status-badge.inactive {
    background: #ffebee;
    color: #c62828;
  }

  .status-badge.success {
    background: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #a5d6a7;
  }

  .status-badge.error {
    background: #ffebee;
    color: #c62828;
    border: 1px solid #ef9a9a;
  }

  .status-badge.pending {
    background: #fff3e0;
    color: #ef6c00;
    border: 1px solid #ffcc02;
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    animation: fadeIn 0.2s ease;
  }

  .modal-content {
    background: var(--color-surface);
    border-radius: 12px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
    animation: slideUp 0.3s ease;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 2px solid var(--color-border);
    background: var(--color-bg);
  }

  .modal-header h3 {
    margin: 0;
    color: var(--color-primary);
    font-size: 1.3rem;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 1.8rem;
    cursor: pointer;
    color: var(--color-muted);
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s ease;
    line-height: 1;
  }

  .modal-close:hover {
    color: var(--color-danger);
    background: rgba(0, 0, 0, 0.05);
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 20px 24px;
    border-top: 2px solid var(--color-border);
    background: var(--color-bg);
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Scrollbar Styling for Logs */
  .logs-viewer::-webkit-scrollbar {
    width: 8px;
  }

  .logs-viewer::-webkit-scrollbar-track {
    background: #2d2d2d;
    border-radius: 4px;
  }

  .logs-viewer::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 4px;
  }

  .logs-viewer::-webkit-scrollbar-thumb:hover {
    background: #777;
  }

  /* Reset Database Styles */
  .btn--danger {
    background: var(--color-danger) !important;
    color: white !important;
    border: 2px solid var(--color-danger) !important;
  }

  .btn--danger:hover {
    background: #dc2626 !important;
    border-color: #dc2626 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
  }

  .danger-warning {
    animation: pulseWarning 2s infinite;
  }

  @keyframes pulseWarning {
    0%, 100% {
      box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4);
    }
    50% {
      box-shadow: 0 0 0 8px rgba(220, 38, 38, 0);
    }
  }

  #verificationCode {
    animation: fadeIn 0.5s ease-in-out;
  }

  #verificationInput:focus {
    outline: none;
    border-color: var(--color-danger);
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
  }

  /* Disable text selection for verification code */
  #verificationCode {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    cursor: default;
  }
  
  /* Countdown animation */
  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.05);
      opacity: 0.8;
    }
  }
  
  #countdownDisplay {
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // System state
  let systemStatus = 'online';
  let autoRefreshInterval = null;
  let currentLogs = [];
  let filteredLogs = [];
  let currentActivities = [];

  // Initialize page
  document.addEventListener('DOMContentLoaded', function () {
    initializeSystemData();
    loadLogs();
    loadActivities();
    // updateSystemHealth(); // ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô

    // Start auto-refresh
    toggleAutoRefresh();

    // Update time display
    updateLastUpdateTime();
    setInterval(updateLastUpdateTime, 1000);
    
    // Setup reset input prevention
    setupResetInputPrevention();
  });

  async function initializeSystemData() {
    try {
      const response = await fetch('/api/system/status');
      const result = await response.json();
      
      if (result.success) {
        systemStatus = result.status || 'online';
        
        // Update UI
        document.querySelectorAll('.status-card').forEach(card => {
          card.classList.remove('active');
        });
        const statusElement = document.getElementById(`status${systemStatus.charAt(0).toUpperCase() + systemStatus.slice(1)}`);
        if (statusElement) {
          statusElement.classList.add('active');
        }
        
        updateStatusDisplay();
      } else {
        systemStatus = 'online';
        updateStatusDisplay();
      }
    } catch (error) {
      console.error('Error loading system status:', error);
      systemStatus = 'online';
      updateStatusDisplay();
    }
  }

  function setSystemStatus(status) {
    const statusText = {
      online: '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥',
      maintenance: '‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤',
      offline: '‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß'
    };

    const statusDesc = {
      online: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥',
      maintenance: '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ',
      offline: '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß'
    };

    // ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
    Swal.fire({
      title: `‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞?`,
      html: `
        <div style="text-align:left;">
          <p style="margin:12px 0;"><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏´‡∏°‡πà:</strong> ${statusText[status]}</p>
          <p style="margin:12px 0;color:var(--color-muted);">${statusDesc[status]}</p>
          <p style="margin:12px 0;padding:12px;background:#fff3cd;border-radius:6px;border-left:4px solid #ffc107;">
            ‚ö†Ô∏è <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
          </p>
        </div>
      `,
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      confirmButtonColor: status === 'offline' ? '#d33' : '#2E3094'
    }).then(async (result) => {
      if (result.isConfirmed) {
        // ‡πÅ‡∏™‡∏î‡∏á Loading
        Swal.fire({
          title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        try {
          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
          const response = await fetch('/api/system/status', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status })
          });

          const result = await response.json();

          if (result.success) {
            systemStatus = status;

            // Update UI
            document.querySelectorAll('.status-card').forEach(card => {
              card.classList.remove('active');
            });
            document.getElementById(`status${status.charAt(0).toUpperCase() + status.slice(1)}`).classList.add('active');
            updateStatusDisplay();

            Swal.fire({
              icon: 'success',
              title: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
              text: `‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "${statusText[status]}" ‡πÅ‡∏•‡πâ‡∏ß`,
              timer: 2000,
              showConfirmButton: false
            });

            // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡∏°‡πà
            loadActivities();
          } else {
            throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
          }
        } catch (error) {
          console.error('Error changing system status:', error);
          Swal.fire({
            icon: 'error',
            title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'
          });
        }
      }
    });
  }

  function updateStatusDisplay() {
    const statusText = {
      online: '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ ‚úÖ',
      maintenance: '‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤ üîß',
      offline: '‡∏õ‡∏¥‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß üö´'
    };

    document.getElementById('currentStatus').textContent = statusText[systemStatus];
  }

  function updateLastUpdateTime() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('th-TH', {
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
    document.getElementById('lastUpdate').textContent = timeStr;
  }



  async function loadLogs() {
    try {
      const response = await fetch('/api/system/logs');
      const result = await response.json();
      
      if (result.success) {
        currentLogs = result.logs || [];
        filteredLogs = [...currentLogs];
        renderLogs();
      } else {
        console.error('Failed to load logs:', result.message);
        currentLogs = [];
        filteredLogs = [];
        renderLogs();
      }
    } catch (error) {
      console.error('Error loading logs:', error);
      currentLogs = [];
      filteredLogs = [];
      renderLogs();
    }
  }

  function renderLogs() {
    const viewer = document.getElementById('logsViewer');

    if (filteredLogs.length === 0) {
      viewer.innerHTML = `
      <div class="log-entry" style="text-align:center;padding:40px;color:#858585;">
        ‡πÑ‡∏°‡πà‡∏û‡∏ö logs ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      </div>
    `;
      return;
    }

    viewer.innerHTML = filteredLogs.map(log => {
      const time = new Date(log.timestamp).toLocaleTimeString('th-TH');
      return `
      <div class="log-entry ${log.level}">
        <span class="log-timestamp">[${time}]</span>
        <span class="log-level ${log.level}">${log.level}</span>
        <span class="log-category">[${log.category}]</span>
        <span class="log-message">${log.message}</span>
      </div>
    `;
    }).join('');

    // Auto-scroll to bottom
    viewer.scrollTop = viewer.scrollHeight;
  }

  function filterLogs() {
    const level = document.getElementById('logLevel').value;
    const category = document.getElementById('logCategory').value;
    const search = document.getElementById('logSearch').value.toLowerCase();

    filteredLogs = currentLogs.filter(log => {
      const matchLevel = !level || log.level === level;
      const matchCategory = !category || log.category === category;
      const matchSearch = !search || log.message.toLowerCase().includes(search);

      return matchLevel && matchCategory && matchSearch;
    });

    renderLogs();
  }

  function clearLogsDisplay() {
    Swal.fire({
      title: '‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ Logs?',
      text: '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡πâ‡∏≤‡∏á logs ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    }).then((result) => {
      if (result.isConfirmed) {
        currentLogs = [];
        filteredLogs = [];
        renderLogs();
        Swal.fire({
          icon: 'success',
          title: '‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          timer: 1500,
          showConfirmButton: false
        });
      }
    });
  }

  function exportLogs() {
    const data = filteredLogs.map(log =>
      `[${log.timestamp}] [${log.level.toUpperCase()}] [${log.category}] ${log.message}`
    ).join('\n');

    const blob = new Blob([data], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `system-logs-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);

    Swal.fire({
      icon: 'success',
      title: 'Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå logs ‡πÅ‡∏•‡πâ‡∏ß',
      timer: 2000,
      showConfirmButton: false
    });
  }

  function toggleAutoRefresh() {
    const checkbox = document.getElementById('autoRefresh');

    if (checkbox.checked) {
      autoRefreshInterval = setInterval(async () => {
        await loadLogs();
        await loadActivities();
      }, 5000);
    } else {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
    }
  }

  async function loadActivities() {
    try {
      const response = await fetch('/api/system/activities');
      const result = await response.json();
      
      if (result.success) {
        currentActivities = result.activities || [];
        renderActivities();
      } else {
        console.error('Failed to load activities:', result.message);
        currentActivities = [];
        renderActivities();
      }
    } catch (error) {
      console.error('Error loading activities:', error);
      currentActivities = [];
      renderActivities();
    }
  }

  function renderActivities() {
    const container = document.getElementById('activityList');

    if (currentActivities.length === 0) {
      container.innerHTML = `
        <div class="activity-item" style="text-align:center;padding:40px;color:var(--color-muted);border:2px dashed var(--color-border);">
          <div style="font-size:3rem;margin-bottom:16px;">üìù</div>
          <h4 style="margin:0 0 8px 0;color:var(--color-text);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
          <p style="margin:0;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö<br><small>‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 5 ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</small></p>
        </div>
      `;
      return;
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 5 ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const recentActivities = currentActivities.slice(0, 5);

    container.innerHTML = recentActivities.map(activity => {
      const iconMap = {
        'login': 'üîê',
        'logout': 'üö™',
        'register': 'üë§', 
        'update': '‚úèÔ∏è',
        'delete': 'üóëÔ∏è',
        'create': '‚ûï',
        'upload': 'üì§',
        'download': 'üì•',
        'view': 'üëÅÔ∏è',
        'approve': '‚úÖ',
        'reject': '‚ùå',
        'evaluation': 'üìä',
        'lesson_plan': 'üìù',
        'profile_update': 'üë§',
        'password_change': 'üîë',
        'system': '‚öôÔ∏è',
        'backup': 'üíæ',
        'error': '‚ö†Ô∏è',
        'success': '‚úÖ'
      };

      const colorMap = {
        'login': '#22c55e',
        'logout': '#6b7280', 
        'register': '#3b82f6',
        'update': '#f59e0b',
        'delete': '#ef4444',
        'create': '#3b82f6',
        'upload': '#8b5cf6',
        'download': '#06b6d4',
        'view': '#84cc16',
        'approve': '#10b981',
        'reject': '#f87171',
        'evaluation': '#f97316',
        'lesson_plan': '#0ea5e9',
        'profile_update': '#14b8a6',
        'password_change': '#e11d48',
        'system': '#64748b',
        'backup': '#7c3aed',
        'error': '#ef4444',
        'success': '#22c55e'
      };

      const icon = iconMap[activity.type] || 'üìù';
      const activityColor = colorMap[activity.type] || '#6b7280';
      const timeAgo = formatTimeAgo(activity.timestamp);

      const userInfo = activity.userId ? 
        `<span style="color: ${activityColor}; font-weight: 600;">${escapeHtml(activity.userName || activity.userId)}</span>` : 
        '<span style="color: var(--color-muted);">‡∏£‡∏∞‡∏ö‡∏ö</span>';

      return `
        <div class="activity-item" style="border-left: 3px solid ${activityColor}; background: linear-gradient(90deg, ${activityColor}10, transparent);">
          <div class="activity-icon" style="color: ${activityColor}; font-size: 1.5rem;">${icon}</div>
          <div class="activity-content">
            <div class="activity-title" style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
              ${userInfo} <span style="color: var(--color-muted);">‚Ä¢</span> <span>${escapeHtml(activity.title)}</span>
            </div>
            <div class="activity-desc" style="margin-bottom: 6px;">${escapeHtml(activity.description)}</div>
            <div class="activity-time" style="display: flex; align-items: center; gap: 12px; font-size: 0.8rem;">
              <span style="color: var(--color-muted);">üïê ${timeAgo}</span>
              ${activity.ipAddress ? `<span style="color: var(--color-muted);">üåê ${activity.ipAddress}</span>` : ''}
              ${activity.status ? `<span class="status-badge ${activity.status}" style="padding: 2px 8px; border-radius: 10px; font-size: 0.7rem;">${activity.status === 'success' ? '‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : activity.status === 'error' ? '‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î' : '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</span>` : ''}
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function formatTimeAgo(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diff = Math.floor((now - time) / 1000); // ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

    if (diff < 60) return '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
    if (diff < 3600) return `${Math.floor(diff / 60)} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
    if (diff < 86400) return `${Math.floor(diff / 3600)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
    if (diff < 2592000) return `${Math.floor(diff / 86400)} ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
    
    return time.toLocaleDateString('th-TH', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async function refreshSystemData() {
    Swal.fire({
      title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    try {
      await Promise.all([
        loadLogs(),
        loadActivities()
      ]);

      Swal.fire({
        icon: 'success',
        title: '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
        timer: 1500,
        showConfirmButton: false
      });
    } catch (error) {
      console.error('Error refreshing data:', error);
      Swal.fire({
        icon: 'error',
        title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'
      });
    }
  }

  function openBackupModal() {
    document.getElementById('backupModal').style.display = 'flex';

    // Set last backup date
    const lastBackup = new Date();
    lastBackup.setDate(lastBackup.getDate() - 1);
    document.getElementById('lastBackupDate').textContent = lastBackup.toLocaleString('th-TH');
  }

  function closeBackupModal() {
    document.getElementById('backupModal').style.display = 'none';
  }

  function performBackup() {
    const backupDB = document.getElementById('backupDB').checked;
    const backupFiles = document.getElementById('backupFiles').checked;
    const backupConfig = document.getElementById('backupConfig').checked;

    if (!backupDB && !backupFiles && !backupConfig) {
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'
      });
      return;
    }

    closeBackupModal();

    Swal.fire({
      title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
      html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà<br><b>0%</b>',
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();

        let progress = 0;
        const interval = setInterval(() => {
          progress += 10;
          Swal.getHtmlContainer().querySelector('b').textContent = `${progress}%`;

          if (progress >= 100) {
            clearInterval(interval);

            Swal.fire({
              icon: 'success',
              title: '‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
              text: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
              timer: 2000
            });

            // Update last backup date
            document.getElementById('lastBackupDate').textContent = new Date().toLocaleString('th-TH');
          }
        }, 300);
      }
    });
  }

  // Reset Database System
  let currentVerificationCode = '';
  let resetCountdownInterval = null;
  let resetCountdownData = null;

  function generateVerificationCode() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
    let result = '';
    for (let i = 0; i < 16; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
  }

  function openResetDatabaseModal() {
    // Generate new verification code
    currentVerificationCode = generateVerificationCode();
    
    // Display the code
    document.getElementById('verificationCode').textContent = currentVerificationCode;
    
    // Clear input
    document.getElementById('verificationInput').value = '';
    
    // Show modal
    document.getElementById('resetDatabaseModal').style.display = 'flex';
    
    // Focus on input
    setTimeout(() => {
      document.getElementById('verificationInput').focus();
    }, 100);
  }

  function closeResetDatabaseModal() {
    // Simply hide the modal. Do NOT clear the verification code here
    // so it remains available for the countdown / reset process.
    document.getElementById('resetDatabaseModal').style.display = 'none';
  }

  function verifyResetDatabase() {
    const inputCode = document.getElementById('verificationInput').value.trim();
    
    if (inputCode === '') {
      Swal.fire({
        icon: 'warning',
        title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
        text: '‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô 16 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô'
      });
      return;
    }
    
    if (inputCode.length !== 16) {
      Swal.fire({
        icon: 'error',
        title: '‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö',
        text: '‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 16 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'
      });
      return;
    }
    
    if (inputCode !== currentVerificationCode) {
      Swal.fire({
        icon: 'error',
        title: '‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        text: '‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á',
        didClose: () => {
          // Generate new code for security
          currentVerificationCode = generateVerificationCode();
          document.getElementById('verificationCode').textContent = currentVerificationCode;
          document.getElementById('verificationInput').value = '';
          document.getElementById('verificationInput').focus();
        }
      });
      return;
    }
    
    // Close reset modal first
    closeResetDatabaseModal();
    
    // Final confirmation
    Swal.fire({
      title: '‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£ Reset ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
      html: `
        <div style="text-align: left; background: #fef2f2; padding: 16px; border-radius: 8px; margin: 16px 0;">
          <h4 style="color: #dc2626; margin: 0 0 12px 0;">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞:</h4>
          <ul style="color: #7f1d1d; margin: 0; padding-left: 20px;">
            <li><strong>‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</strong></li>
            <li><strong>‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</strong></li>
            <li><strong>‡∏•‡∏ö‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</strong></li>
            <li><strong>‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏π‡∏û‡∏µ‡πà‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</strong></li>
            <li><strong>‡∏™‡∏£‡πâ‡∏≤‡∏á Admin ‡πÉ‡∏´‡∏°‡πà:</strong> admin/admin123</li>
          </ul>
          <p style="color: #dc2626; font-weight: 600; margin: 12px 0 0 0;">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ!</p>
        </div>
        <p style="font-size: 1.1rem; color: #dc2626; font-weight: 600;">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
      `,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Reset ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',
      cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
      confirmButtonColor: '#dc2626',
      cancelButtonColor: '#6b7280',
      reverseButtons: true
    }).then(async (result) => {
      if (result.isConfirmed) {
        await performDatabaseReset();
      }
    });
  }

  async function performDatabaseReset() {
    // Start 10-minute countdown
    startResetCountdown();
  }
  
  function startResetCountdown() {
    const countdownMinutes = 10;
    const countdownStart = new Date();
    const countdownEnd = new Date(countdownStart.getTime() + countdownMinutes * 60 * 1000);
    
    // Store the verification code in the countdown data
    resetCountdownData = {
      startTime: countdownStart,
      endTime: countdownEnd,
      verificationCode: currentVerificationCode
    };
    
    console.log('Starting countdown with verification code:', currentVerificationCode);
    
    // Show countdown modal
    showCountdownModal();
    
    // Start countdown interval
    resetCountdownInterval = setInterval(() => {
      updateCountdownDisplay();
    }, 1000);
  }
  
  function showCountdownModal() {
    Swal.fire({
      title: '‚è∞ Reset Database - Countdown',
      html: `
        <div style="text-align: center;">
          <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
            <div style="font-size: 2rem; margin-bottom: 10px;">‚è∞</div>
            <h3 style="color: #92400e; margin: 0 0 10px 0;">Countdown ‡∏Å‡πà‡∏≠‡∏ô Reset Database</h3>
            <p style="color: #7c2d12; margin: 0;">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Reset ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô:</p>
          </div>
          
          <div id="countdownDisplay" style="font-size: 3rem; font-weight: bold; color: #dc2626; margin: 20px 0; font-family: 'Courier New', monospace;">
            10:00
          </div>
          
          <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin: 20px 0;">
            <h4 style="color: #dc2626; margin: 0 0 10px 0;">‚ö†Ô∏è ‡∏≠‡∏µ‡∏Å 10 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞:</h4>
            <ul style="text-align: left; color: #7f1d1d; margin: 0; padding-left: 20px;">
              <li>‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
              <li>‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
              <li>‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
              <li>‡∏™‡∏£‡πâ‡∏≤‡∏á Admin ‡πÉ‡∏´‡∏°‡πà (admin/admin123)</li>
            </ul>
          </div>
          
          <p style="color: #059669; font-weight: 600;">‚úÖ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</p>
        </div>
      `,
      showCancelButton: true,
      confirmButtonText: '‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£ Reset',
      cancelButtonText: '‚è±Ô∏è ‡∏£‡∏≠ Countdown ‡∏ï‡πà‡∏≠‡πÑ‡∏õ',
      confirmButtonColor: '#16a34a',
      cancelButtonColor: '#6b7280',
      allowOutsideClick: false,
      allowEscapeKey: false,
      reverseButtons: true
    }).then((result) => {
      if (result.isConfirmed) {
        cancelResetCountdown();
      } else if (result.isDismissed) {
        // ‡∏õ‡∏¥‡∏î modal ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏£‡∏±‡∏ô countdown ‡∏ï‡πà‡∏≠
        Swal.close();
      }
    });
  }
  
  function updateCountdownDisplay() {
    if (!resetCountdownData) return;
    
    const now = new Date();
    const remaining = Math.max(0, resetCountdownData.endTime.getTime() - now.getTime());
    
    if (remaining <= 0) {
      // Time's up - execute reset
      clearInterval(resetCountdownInterval);
      resetCountdownInterval = null;
      Swal.close();
      executeActualReset();
      return;
    }
    
    const minutes = Math.floor(remaining / (1000 * 60));
    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
    
    const countdownElement = document.getElementById('countdownDisplay');
    if (countdownElement) {
      countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      // Change color as time runs out
      if (remaining < 60000) { // Less than 1 minute
        countdownElement.style.color = '#dc2626';
        countdownElement.style.animation = 'pulse 1s infinite';
      } else if (remaining < 180000) { // Less than 3 minutes
        countdownElement.style.color = '#f59e0b';
      }
    }
  }
  
  function cancelResetCountdown() {
    if (resetCountdownInterval) {
      clearInterval(resetCountdownInterval);
      resetCountdownInterval = null;
    }
    // Clear countdown data and verification code when user cancels
    resetCountdownData = null;
    currentVerificationCode = '';
    
    Swal.fire({
      icon: 'info',
      title: '‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£ Reset ‡πÅ‡∏•‡πâ‡∏ß',
      text: '‡∏Å‡∏≤‡∏£ Reset Database ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
      timer: 2000,
      showConfirmButton: false
    });
  }
  
  async function executeActualReset() {
    // Get verification code from countdown data or current verification code
    const verificationCodeToUse = resetCountdownData?.verificationCode || currentVerificationCode;
    
    // Debug: Check if verification code exists
    if (!verificationCodeToUse) {
      Swal.fire({
        icon: 'error',
        title: '‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà',
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
      });
      return;
    }
    
    console.log('Sending reset request with verification code:', verificationCodeToUse);
    
    Swal.fire({
      title: 'üóëÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á Reset ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
      html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£ Reset...<br><div style="color: #dc2626; font-weight: 600;">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß!</div>',
      allowOutsideClick: false,
      allowEscapeKey: false,
      didOpen: () => {
        Swal.showLoading();
      }
    });

    try {
      const requestData = {
        verificationCode: verificationCodeToUse,
        confirmed: true,
        timestamp: new Date().toISOString()
      };
      
      console.log('Request data:', requestData);
      
      const response = await fetch('/api/system/reset-database', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
      });

      if (!response.ok) {
        let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
        
        try {
          const errorText = await response.text();
          console.error('Server error response:', errorText);
          
          // Try to parse JSON error response
          try {
            const errorJson = JSON.parse(errorText);
            if (errorJson.message) {
              errorMessage = errorJson.message;
            }
          } catch (jsonError) {
            // If not JSON, use text as is
            if (errorText) {
              errorMessage = errorText;
            }
          }
        } catch (textError) {
          console.error('Error reading response text:', textError);
        }
        
        throw new Error(errorMessage);
      }
      
      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        const text = await response.text();
        throw new Error('‡πÄ‡∏ã‡∏¥‡∏£‡πå‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON: ' + text.substring(0, 100));
      }

      const result = await response.json();

      if (result.success) {
        Swal.fire({
          icon: 'success',
          title: '‚úÖ Reset ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
          html: `
            <div style="text-align: left; background: #f0fdf4; padding: 16px; border-radius: 8px; margin: 16px 0;">
              <h4 style="color: #16a34a; margin: 0 0 12px 0;">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:</h4>
              <ul style="color: #15803d; margin: 0; padding-left: 20px;">
                <li>‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß</li>
                <li>‡∏™‡∏£‡πâ‡∏≤‡∏á Admin ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß</li>
                <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</li>
              </ul>
              <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 6px; padding: 12px; margin-top: 16px;">
                <strong style="color: #92400e;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà:</strong><br>
                <code style="background: #fff; padding: 4px 8px; border-radius: 4px; color: #1f2937;">Username: admin</code><br>
                <code style="background: #fff; padding: 4px 8px; border-radius: 4px; color: #1f2937;">Password: admin123</code>
              </div>
            </div>
          `,
          confirmButtonText: 'üîÑ ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö',
          allowOutsideClick: false
        }).then(() => {
          // Reload the page
          window.location.reload();
        });
      } else {
        throw new Error(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ Reset ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      }
    } catch (error) {
      console.error('Error resetting database:', error);
      Swal.fire({
        icon: 'error',
        title: '‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
        text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Reset ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ' + error.message,
        confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
      });
    } finally {
      // Always clear verification/ countdown state after attempt
      try {
        if (resetCountdownInterval) {
          clearInterval(resetCountdownInterval);
          resetCountdownInterval = null;
        }
      } catch (e) {
        console.error('Error clearing countdown interval in finally:', e);
      }

      resetCountdownData = null;
      currentVerificationCode = '';
    }
  }

  // Setup input prevention for reset verification
  function setupResetInputPrevention() {
    // Use event delegation since the input might not exist yet
    document.addEventListener('paste', function(e) {
      if (e.target && e.target.id === 'verificationInput') {
        e.preventDefault();
        Swal.fire({
          icon: 'warning',
          title: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ Paste',
          text: '‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á',
          timer: 2000
        });
      }
    });
      
    document.addEventListener('drop', function(e) {
      if (e.target && e.target.id === 'verificationInput') {
        e.preventDefault();
      }
    });
      
    document.addEventListener('contextmenu', function(e) {
      if (e.target && e.target.id === 'verificationInput') {
        e.preventDefault();
      }
    });
      
    document.addEventListener('input', function(e) {
      if (e.target && e.target.id === 'verificationInput') {
        // Allow only English letters
        e.target.value = e.target.value.replace(/[^A-Za-z]/g, '');
      }
    });
    
    // Prevent common keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.target && e.target.id === 'verificationInput') {
        // Prevent Ctrl+V, Ctrl+C, Ctrl+X, Ctrl+A
        if (e.ctrlKey && (e.key === 'v' || e.key === 'c' || e.key === 'x' || e.key === 'a')) {
          e.preventDefault();
          if (e.key === 'v') {
            Swal.fire({
              icon: 'warning',
              title: '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï Keyboard Shortcuts',
              text: '‡πÇ‡∏õ‡∏£‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á',
              timer: 1500
            });
          }
        }
      }
    });
  }

  // Close modal when clicking outside
  window.onclick = function (event) {
    const backupModal = document.getElementById('backupModal');
    const resetModal = document.getElementById('resetDatabaseModal');
    
    if (event.target === backupModal) {
      closeBackupModal();
    }
    
    if (event.target === resetModal) {
      closeResetDatabaseModal();
    }
  }
</script>