<%
  // Mock comprehensive student data for reports
  const allStudents = [
    {
      id: '6414421001',
      firstName: '‡∏™‡∏°‡∏ä‡∏≤‡∏¢',
      lastName: '‡πÉ‡∏à‡∏î‡∏µ',
      year: 1,
      evaluationData: {
        personality: 4.5,
        teaching: 4.2,
        planning: 4.0,
        classroom: 4.3,
        assessment: 3.8,
        innovation: 4.6,
        responsibility: 4.8,
        punctuality: 4.7
      }
    },
    {
      id: '6414421002',
      firstName: '‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á',
      lastName: '‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
      year: 1,
      evaluationData: {
        personality: 4.7,
        teaching: 4.5,
        planning: 4.3,
        classroom: 4.6,
        assessment: 4.2,
        innovation: 4.8,
        responsibility: 4.9,
        punctuality: 4.8
      }
    },
    {
      id: '6314421001',
      firstName: '‡∏ß‡∏¥‡∏ä‡∏±‡∏¢',
      lastName: '‡∏°‡∏≤‡∏ô‡∏∞',
      year: 2,
      evaluationData: {
        personality: 4.3,
        teaching: 4.1,
        planning: 3.9,
        classroom: 4.2,
        assessment: 3.7,
        innovation: 4.4,
        responsibility: 4.6,
        punctuality: 4.5
      }
    },
    {
      id: '6314421002',
      firstName: '‡∏™‡∏∏‡∏î‡∏≤',
      lastName: '‡∏™‡∏∏‡∏Ç‡πÉ‡∏à',
      year: 2,
      evaluationData: {
        personality: 4.8,
        teaching: 4.6,
        planning: 4.5,
        classroom: 4.7,
        assessment: 4.4,
        innovation: 4.9,
        responsibility: 5.0,
        punctuality: 4.9
      }
    },
    {
      id: '6214421001',
      firstName: '‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏ó‡∏ò',
      lastName: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤',
      year: 3,
      evaluationData: {
        personality: 4.2,
        teaching: 4.0,
        planning: 3.8,
        classroom: 4.1,
        assessment: 3.6,
        innovation: 4.3,
        responsibility: 4.5,
        punctuality: 4.4
      }
    },
    {
      id: '6214421002',
      firstName: '‡∏≠‡∏£‡∏∏‡∏ì',
      lastName: '‡∏â‡∏•‡∏≤‡∏î',
      year: 3,
      evaluationData: {
        personality: 4.6,
        teaching: 4.4,
        planning: 4.2,
        classroom: 4.5,
        assessment: 4.1,
        innovation: 4.7,
        responsibility: 4.8,
        punctuality: 4.7
      }
    },
    {
      id: '6114421001',
      firstName: '‡∏°‡∏≤‡∏ô‡∏∞',
      lastName: '‡∏Ç‡∏¢‡∏±‡∏ô',
      year: 4,
      evaluationData: {
        personality: 4.4,
        teaching: 4.2,
        planning: 4.0,
        classroom: 4.3,
        assessment: 3.9,
        innovation: 4.5,
        responsibility: 4.7,
        punctuality: 4.6
      }
    },
    {
      id: '6114421002',
      firstName: '‡∏ß‡∏£‡∏£‡∏ì‡∏≤',
      lastName: '‡πÄ‡∏Å‡πà‡∏á‡∏Å‡∏≤‡∏£',
      year: 4,
      evaluationData: {
        personality: 4.9,
        teaching: 4.7,
        planning: 4.6,
        classroom: 4.8,
        assessment: 4.5,
        innovation: 5.0,
        responsibility: 5.0,
        punctuality: 5.0
      }
    }
  ];

  // Category labels
  const categoriesLabel = {
    personality: '‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå',
    teaching: '‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô',
    planning: '‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô',
    classroom: '‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
    assessment: '‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•',
    innovation: '‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô',
    responsibility: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö',
    punctuality: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤'
  };

  // Calculate category averages
  const categoryAverages = {};
  Object.keys(categoriesLabel).forEach(key => {
    const total = allStudents.reduce((sum, student) => sum + student.evaluationData[key], 0);
    categoryAverages[key] = (total / allStudents.length).toFixed(2);
  });

  // Calculate overall stats
  const totalStudents = allStudents.length;
  const grandAverage = (Object.values(categoryAverages).reduce((sum, val) => sum + parseFloat(val), 0) / Object.keys(categoryAverages).length).toFixed(2);
  
  // Additional statistics
  const allScores = allStudents.flatMap(s => Object.values(s.evaluationData));
  const min = Math.min(...allScores);
  const max = Math.max(...allScores);
  const excellent = allScores.filter(s => s >= 4.5).length;
  const needImprovement = allScores.filter(s => s < 3.5).length;
%>

<div class="page-content">
<div class="card">
<div class="page-header">
<div class="header-content">
<h2 class="page-title">
  <span>üìä</span>
  ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå
</h2>
<p class="text-muted">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
</div>
<div class="header-actions">
  <button class="btn btn--secondary" onclick="refreshData()">
    <span>üîÑ</span> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
  </button>
  <button class="btn btn--primary" onclick="openExportModal()">
    <span>üì•</span> Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  </button>
  <button class="btn btn--primary" onclick="printReport()">
    <span>üñ®Ô∏è</span> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
  </button>
</div>
</div>

<!-- Filter Controls -->
<div class="filter-section">
  <h3 class="filter-title">üîç ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
  <div class="filter-grid">
    <div class="form-group" style="margin:0;">
      <label class="form-label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</label>
      <input type="text" id="searchStudent" class="form-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤..." onkeyup="applyFilters()">
    </div>
    
    <div class="form-group" style="margin:0;">
      <label class="form-label">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</label>
      <select id="filterYear" class="form-input" onchange="applyFilters()">
        <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</option>
        <option value="1">‡∏õ‡∏µ 1</option>
        <option value="2">‡∏õ‡∏µ 2</option>
        <option value="3">‡∏õ‡∏µ 3</option>
        <option value="4">‡∏õ‡∏µ 4</option>
      </select>
    </div>

    <div class="form-group" style="margin:0;">
      <label class="form-label">‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</label>
      <select id="filterScore" class="form-input" onchange="applyFilters()">
        <option value="">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
        <option value="excellent">‡∏î‡∏µ‡∏°‡∏≤‡∏Å (4.5-5.0)</option>
        <option value="verygood">‡∏î‡∏µ (4.0-4.49)</option>
        <option value="good">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á (3.5-3.99)</option>
        <option value="fair">‡∏û‡∏≠‡πÉ‡∏ä‡πâ (3.0-3.49)</option>
        <option value="poor">‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á (&lt;3.0)</option>
      </select>
    </div>

    <div class="form-group" style="margin:0;">
      <label class="form-label">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°</label>
      <select id="sortBy" class="form-input" onchange="applyFilters()">
        <option value="name">‡∏ä‡∏∑‡πà‡∏≠ (‡∏Å-‡∏Æ)</option>
        <option value="id">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
        <option value="year">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</option>
        <option value="score-desc">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</option>
        <option value="score-asc">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</option>
      </select>
    </div>
  </div>
</div>

<!-- Overall Statistics Dashboard -->
<div class="stats-section">
  <h3 class="section-title">
    <span>üìà</span> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
  </h3>
  
  <div class="stats-overview-grid">
    <div class="stat-card">
      <div class="stat-icon">üë•</div>
      <div class="stat-content">
        <div class="stat-value"><%= totalStudents %></div>
        <div class="stat-label">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">‚≠ê</div>
      <div class="stat-content">
        <div class="stat-value"><%= grandAverage %></div>
        <div class="stat-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°</div>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">üèÜ</div>
      <div class="stat-content">
        <div class="stat-value"><%= allStudents.filter(s => {
          const avg = Object.values(s.evaluationData).reduce((sum, val) => sum + val, 0) / Object.keys(s.evaluationData).length;
          return avg >= 4.5;
        }).length %></div>
        <div class="stat-label">‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏î‡∏µ‡∏°‡∏≤‡∏Å</div>
      </div>
    </div>
    
    <div class="stat-card">
      <div class="stat-icon">üìö</div>
      <div class="stat-content">
        <div class="stat-value"><%= Object.keys(categoriesLabel).length %></div>
        <div class="stat-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</div>
      </div>
    </div>
  </div>

  <!-- Year Distribution -->
  <div class="year-distribution">
    <h4 style="margin:16px 0 12px 0;color:var(--color-text);">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</h4>
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;">
      <% for(let year = 1; year <= 4; year++) { 
        const count = allStudents.filter(s => s.year === year).length;
      %>
        <div class="year-badge" style="background:var(--color-bg);padding:12px;border-radius:8px;text-align:center;">
          <div style="font-size:1.5rem;font-weight:600;color:var(--color-primary);"><%= count %></div>
          <div style="font-size:0.9rem;color:var(--color-muted);">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ‡∏ó‡∏µ‡πà <%= year %></div>
        </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Charts Section -->
<div class="charts-section">
  <h3 class="section-title">
    <span>üìä</span> ‡∏Å‡∏£‡∏≤‡∏ü‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  </h3>
  
  <!-- Overall Average Bar Chart -->
  <div class="card chart-card">
    <h4 class="chart-title">
      <span>üìä</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏î‡πâ‡∏≤‡∏ô (‡∏ó‡∏∏‡∏Å‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤)
    </h4>
    <canvas id="overallBarChart"></canvas>
  </div>

  <!-- Charts Grid -->
  <div class="charts-grid">
    <div class="card chart-card">
      <h4 class="chart-title">
        <span>üìâ</span> ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤
      </h4>
      <canvas id="trendLineChart"></canvas>
    </div>
    
    <div class="card chart-card">
      <h4 class="chart-title">
        <span>ü•ß</span> ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
      </h4>
      <canvas id="distributionPieChart"></canvas>
    </div>
  </div>

  <div class="charts-grid">
    <div class="card chart-card">
      <h4 class="chart-title">
        <span>üï∏Ô∏è</span> ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Radar)
      </h4>
      <canvas id="skillsRadarChart"></canvas>
    </div>
    
    <div class="card chart-card">
      <h4 class="chart-title">
        <span>üìä</span> ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ï‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ
      </h4>
      <canvas id="yearComparisonChart"></canvas>
    </div>
  </div>

  <div class="charts-grid">
    <div class="card chart-card">
      <h4 class="chart-title">
        <span>üç©</span> ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
      </h4>
      <canvas id="performanceDoughnutChart"></canvas>
    </div>
    
    <div class="card chart-card">
      <h4 class="chart-title">
        <span>üóª</span> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏±‡∏Å‡∏©‡∏∞
      </h4>
      <canvas id="skillsAreaChart"></canvas>
    </div>
  </div>

  <div class="card chart-card">
    <h4 class="chart-title">
      <span>üîµ</span> ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (Scatter Plot)
    </h4>
    <canvas id="studentScatterChart"></canvas>
  </div>
</div>

<!-- Detailed Student Comparison Table -->
<div class="table-section">
  <h3 class="section-title">
    <span>üìã</span> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
  </h3>
  
  <div class="table-responsive">
    <table class="data-table" id="studentsTable">
      <thead>
        <tr>
          <th rowspan="2" style="vertical-align:middle;">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤</th>
          <th rowspan="2" style="vertical-align:middle;">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          <th rowspan="2" style="vertical-align:middle;">‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏µ</th>
          <% Object.entries(categoriesLabel).forEach(entry => { %>
            <th><%= entry[1] %></th>
          <% }); %>
          <th rowspan="2" style="vertical-align:middle;background:#f0f9ff;">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
          <th rowspan="2" style="vertical-align:middle;">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <% allStudents.forEach(student => {
          const studentAvg = Object.values(student.evaluationData).reduce((sum, val) => sum + val, 0) / Object.keys(student.evaluationData).length;
          const gradeText = studentAvg >= 4.5 ? '‡∏î‡∏µ‡∏°‡∏≤‡∏Å' : studentAvg >= 4 ? '‡∏î‡∏µ' : studentAvg >= 3.5 ? '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á' : studentAvg >= 3 ? '‡∏û‡∏≠‡πÉ‡∏ä‡πâ' : '‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á';
          const gradeClass = studentAvg >= 4.5 ? 'grade-excellent' : studentAvg >= 4 ? 'grade-verygood' : studentAvg >= 3.5 ? 'grade-good' : studentAvg >= 3 ? 'grade-fair' : 'grade-poor';
        %>
          <tr class="student-row" data-student-id="<%= student.id %>" data-year="<%= student.year %>" data-avg="<%= studentAvg.toFixed(2) %>">
            <td><strong><%= student.id %></strong></td>
            <td><%= student.firstName %> <%= student.lastName %></td>
            <td style="text-align:center;"><span class="year-badge-sm">‡∏õ‡∏µ <%= student.year %></span></td>
            <% Object.keys(categoriesLabel).forEach(key => {
              const score = student.evaluationData[key];
              const scoreClass = score >= 4.5 ? 'score-excellent' : score >= 4 ? 'score-verygood' : score >= 3.5 ? 'score-good' : score >= 3 ? 'score-fair' : 'score-poor';
            %>
              <td style="text-align:center;" class="<%= scoreClass %>-cell">
                <%= score.toFixed(1) %>
              </td>
            <% }); %>
            <td style="text-align:center;background:#f0f9ff;font-weight:700;font-size:1.05rem;">
              <%= studentAvg.toFixed(2) %>
            </td>
            <td style="text-align:center;"><span class="grade-badge <%= gradeClass %>"><%= gradeText %></span></td>
          </tr>
        <% }); %>
      </tbody>
      <tfoot>
        <tr style="background:var(--color-primary);color:white;font-weight:600;">
          <td colspan="3" style="text-align:center;">‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</td>
          <% Object.keys(categoriesLabel).forEach(key => { %>
            <td style="text-align:center;"><%= categoryAverages[key] %></td>
          <% }); %>
          <td style="text-align:center;background:#1e40af;"><%= grandAverage %></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- Category Deep Analysis -->
<div class="analysis-section">
  <h3 class="section-title">
    <span>üî¨</span> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
  </h3>
  
  <div class="category-analysis-grid">
    <% Object.entries(categoriesLabel).forEach(([key, label]) => {
      const scores = allStudents.map(s => s.evaluationData[key]);
      const avg = (scores.reduce((sum, val) => sum + val, 0) / scores.length).toFixed(2);
      const min = Math.min(...scores).toFixed(1);
      const max = Math.max(...scores).toFixed(1);
      const excellent = scores.filter(s => s >= 4.5).length;
      const needImprovement = scores.filter(s => s < 3.5).length;
    %>
      <div class="category-card">
        <div class="category-header">
          <h4><%= label %></h4>
          <div class="category-avg"><%= avg %></div>
        </div>
        <div class="category-stats">
          <div class="stat-row">
            <span class="stat-label">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:</span>
            <span class="stat-value" style="color:#16A34A;"><%= max %></span>
          </div>
          <div class="stat-row">
            <span class="stat-label">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î:</span>
            <span class="stat-value" style="color:#DC2626;"><%= min %></span>
          </div>
          <div class="stat-row">
            <span class="stat-label">‡∏î‡∏µ‡∏°‡∏≤‡∏Å:</span>
            <span class="stat-value"><%= excellent %> ‡∏Ñ‡∏ô</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤:</span>
            <span class="stat-value"><%= needImprovement %> ‡∏Ñ‡∏ô</span>
          </div>
        </div>
      </div>
    <% }); %>
  </div>
</div>

</div>
</div>

<!-- Export Modal -->
<div id="exportModal" class="modal-overlay" style="display:none">
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header">
      <h3>üì• Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
      <button type="button" class="modal-close" onclick="closeExportModal()">√ó</button>
    </div>
    
    <div class="modal-body" style="padding:24px;">
      <div class="form-group">
        <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£ Export</label>
        <div style="display:flex;flex-direction:column;gap:12px;margin-top:12px;">
          <button class="export-option-btn" onclick="exportToPDF()">
            <span style="font-size:2rem;">üìÑ</span>
            <div>
              <div style="font-weight:600;">PDF Document</div>
              <div style="font-size:0.85rem;color:var(--color-muted);">‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</div>
            </div>
          </button>
          
          <button class="export-option-btn" onclick="exportToExcel()">
            <span style="font-size:2rem;">üìä</span>
            <div>
              <div style="font-weight:600;">Excel Spreadsheet</div>
              <div style="font-size:0.85rem;color:var(--color-muted);">‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            </div>
          </button>
          
          <button class="export-option-btn" onclick="exportToCSV()">
            <span style="font-size:2rem;">üìã</span>
            <div>
              <div style="font-weight:600;">CSV File</div>
              <div style="font-size:0.85rem;color:var(--color-muted);">‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
            </div>
          </button>
          
          <button class="export-option-btn" onclick="exportToJSON()">
            <span style="font-size:2rem;">üîß</span>
            <div>
              <div style="font-weight:600;">JSON Data</div>
              <div style="font-size:0.85rem;color:var(--color-muted);">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
            </div>
          </button>
        </div>
      </div>
    </div>
    
    <div class="modal-footer">
      <button type="button" class="btn btn--secondary" onclick="closeExportModal()">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>
</div>

<link rel="stylesheet" href="/css/reports.css">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
  // Pass server-side data to the external reports script
  window.reportsData = {
    studentsData: <%- JSON.stringify(allStudents) %>,
    categoriesLabel: <%- JSON.stringify(categoriesLabel) %>,
    categoryAverages: <%- JSON.stringify(categoryAverages) %>,
    grandAverage: <%- JSON.stringify(grandAverage) %>
  };
</script>

<script src="/js/reports.js"></script>